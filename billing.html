<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WR Smile & Supplies | Billing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(145deg, #f0f4f8, #d9e2ec);
            color: #334155;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 1100px;
        }
        .card {
            background-color: #ffffff;
            border-radius: 1.5rem;
            padding: 2.5rem;
            box-shadow: 10px 10px 20px rgba(0, 0, 0, 0.05), -10px -10px 20px rgba(255, 255, 255, 0.5);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.6);
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 15px 15px 30px rgba(0, 0, 0, 0.07), -15px -15px 30px rgba(255, 255, 255, 0.7);
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
        }
        .input-style {
            padding: 0.75rem 1.5rem;
            border: none;
            background-color: #f0f4f8;
            border-radius: 9999px;
            box-shadow: inset 2px 2px 5px #c8d3e0, inset -2px -2px 5px #ffffff;
            transition: all 0.3s ease;
            width: 100%;
        }
        .input-style:focus {
            outline: none;
            box-shadow: inset 3px 3px 8px #b9c7d8, inset -3px -3px 8px #ffffff;
        }
        .btn-style {
            padding: 0.75rem 2rem;
            border: none;
            font-weight: 600;
            border-radius: 9999px;
            box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.1), -5px -5px 10px rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .btn-style:hover {
            transform: translateY(-2px);
            box-shadow: 8px 8px 15px rgba(0, 0, 0, 0.1), -8px -8px 15px rgba(255, 255, 255, 0.6);
        }
        .btn-style:active {
            transform: translateY(0);
            box-shadow: inset 3px 3px 6px rgba(0, 0, 0, 0.2), inset -3px -3px 6px rgba(255, 255, 255, 0.4);
        }
        .btn-primary {
            background-color: #4f46e5;
            color: #ffffff;
        }
        .btn-danger {
            background-color: #ef4444;
            color: #ffffff;
        }
        .btn-checkout {
            background-color: #10b981;
            color: #ffffff;
        }
        .btn-remove-item {
            background-color: transparent;
            color: #dc2626;
            box-shadow: none;
        }
        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: #ffffff;
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 10px 10px 20px rgba(0, 0, 0, 0.1), -10px -10px 20px rgba(255, 255, 255, 0.6);
            max-width: 500px;
            width: 90%;
            position: relative;
        }
        .custom-alert {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1001;
            animation: fade-in-up 0.5s ease-out forwards;
        }
        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container mx-auto p-4">
        <h1 class="text-4xl text-center mb-8">WR Smile & Supplies | Billing</h1>
        <p id="userIdDisplay" class="text-xs text-center text-gray-400 mb-4"></p>
        <div class="card p-6 grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="flex flex-col space-y-4">
                <h2 class="text-3xl font-playfair mb-4">New Bill</h2>
                <!-- Customer Section -->
                <div id="customerSearchSection">
                    <div class="relative mb-6">
                        <label for="customerSearch" class="block text-sm font-medium text-gray-700 mb-1">Customer Details</label>
                        <input type="text" id="customerSearch" placeholder="Search or add a customer..." class="input-style pr-12">
                        <i class="fas fa-search absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 mt-2"></i>
                        <ul id="customerSearchResults" class="absolute w-full mt-2 bg-white rounded-lg shadow-lg z-10 hidden"></ul>
                    </div>
                    <button id="manualCustomerToggleBtn" class="btn-style btn-primary w-full mt-4">Or, Manual Add Customer</button>
                </div>
                
                <!-- Manual Customer Add Section (Initially Hidden) -->
                <div id="manualCustomerSection" class="hidden">
                    <h3 class="text-xl font-playfair mb-2">Manually Add Customer</h3>
                    <div class="space-y-4">
                        <input type="text" id="manualCustomerNameInput" placeholder="Customer Name" class="input-style">
                        <input type="tel" id="manualCustomerPhoneInput" placeholder="Customer Phone (Ex: 712345678)" class="input-style">
                        <div class="flex items-center space-x-4">
                            <button id="addManualCustomerBtn" class="btn-style btn-primary flex-grow">Add Customer</button>
                            <button id="manualCustomerCancelBtn" class="btn-style btn-danger">Cancel</button>
                        </div>
                    </div>
                </div>

                <!-- Product Add Section -->
                <div id="productSearchSection">
                    <div class="relative">
                        <input type="text" id="productSearch" placeholder="Search products..." class="input-style pr-12">
                        <i class="fas fa-search absolute right-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <ul id="searchResults" class="absolute w-full mt-2 bg-white rounded-lg shadow-lg z-10 hidden"></ul>
                    </div>
                    <div id="selectedProductDetails" class="hidden flex flex-col space-y-4 p-4 rounded-lg bg-gray-50 border border-gray-200 mt-4">
                        <p class="font-bold text-lg"><span id="productName"></span></p>
                        <p class="text-sm text-gray-600">Price: Rs <span id="productPrice"></span></p>
                        <p class="text-sm text-gray-600">Stock: <span id="productStock"></span></p>
                        <div class="flex items-center space-x-4">
                            <input type="number" id="quantityInput" value="1" min="1" class="input-style w-24">
                            <button id="addItemBtn" class="btn-style btn-primary flex-grow">Add to Bill</button>
                        </div>
                    </div>
                    <button id="manualAddToggleBtn" class="btn-style btn-primary w-full mt-4">Or, Manual Add Product</button>
                </div>
                
                <!-- Manual Product Add Section (Initially Hidden) -->
                <div id="manualAddSection" class="hidden">
                    <h3 class="text-xl font-playfair mb-2">Manually Add Item</h3>
                    <div class="space-y-4">
                        <input type="text" id="manualProductName" placeholder="Product Name" class="input-style">
                        <input type="number" id="manualProductPrice" placeholder="Price" class="input-style">
                        <input type="number" id="manualQuantity" placeholder="Quantity" value="1" min="1" class="input-style">
                        <div class="flex items-center space-x-4">
                            <button id="addManualItemBtn" class="btn-style btn-primary flex-grow">Add to Bill</button>
                            <button id="manualAddCancelBtn" class="btn-style btn-danger">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
            <div>
                <h2 class="text-3xl font-playfair mb-4">Bill Summary</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-left table-auto">
                        <thead>
                            <tr class="text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6">Item</th>
                                <th class="py-3 px-6">Qty</th>
                                <th class="py-3 px-6">Price</th>
                                <th class="py-3 px-6 text-right">Subtotal</th>
                                <th class="py-3 px-6"></th>
                            </tr>
                        </thead>
                        <tbody id="billItemsContainer" class="text-gray-600 text-sm font-light">
                            <!-- Bill items will be injected here -->
                        </tbody>
                    </table>
                </div>
                <div class="mt-8 space-y-4">
                    <div class="flex justify-between items-center text-md font-bold text-gray-700">
                        <span>Subtotal:</span>
                        <span id="subtotalAmount">Rs 0.00</span>
                    </div>
                    <div class="flex justify-between items-center text-md font-bold text-gray-700">
                        <span>Discount:</span>
                        <input type="number" id="discountAmountInput" value="0" min="0" class="input-style w-24 text-right">
                    </div>
                    <div class="flex justify-between items-center text-xl font-bold border-t pt-4 border-gray-200">
                        <span>Total:</span>
                        <span id="totalAmount" class="text-2xl text-primary-600">Rs 0.00</span>
                    </div>
                    <div class="flex justify-end space-x-4 mt-4">
                        <button id="clearBillBtn" class="btn-style btn-danger">Clear Bill</button>
                        <button id="checkoutBtn" class="btn-style btn-checkout">Checkout</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Finalize Modal -->
    <div id="finalizeModal" class="custom-modal hidden">
        <div class="modal-content">
            <h3 class="text-2xl mb-4 font-playfair">Finalize Sale</h3>
            <div class="space-y-4">
                <div class="flex justify-between">
                    <span class="text-lg">Final Total:</span>
                    <span id="modalTotal" class="text-lg font-bold">Rs 0.00</span>
                </div>
                <div>
                    <label for="customerNameInput" class="block text-gray-700">Customer Name</label>
                    <input type="text" id="customerNameInput" class="input-style mt-1" placeholder="Enter customer name">
                </div>
                <div>
                    <label for="customerPhoneInput" class="block text-gray-700">Customer Phone (WhatsApp)</label>
                    <input type="tel" id="customerPhoneInput" class="input-style mt-1" placeholder="Ex: 712345678">
                </div>
                <div>
                    <label for="amountPaidInput" class="block text-gray-700">Amount Paid</label>
                    <input type="number" id="amountPaidInput" class="input-style mt-1" placeholder="Enter amount paid">
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-lg">Balance / Loan:</span>
                    <span id="loanAmount" class="text-lg font-bold text-red-600">Rs 0.00</span>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button id="newBillBtn" class="btn-style btn-primary">Start New Bill</button>
                    <button id="sendWhatsappBtn" class="btn-style btn-checkout">
                        <i class="fab fa-whatsapp mr-2"></i>Send on WhatsApp
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="alert-container" class="alert-container"></div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, runTransaction, doc, addDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

        // Global variables and Firebase setup
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let allProducts = [];
        let allCustomers = [];
        let billItems = [];

        // UI Element References
        const productSearchInput = document.getElementById('productSearch');
        const searchResultsList = document.getElementById('searchResults');
        const selectedProductDetailsDiv = document.getElementById('selectedProductDetails');
        const productNameSpan = document.getElementById('productName');
        const productPriceSpan = document.getElementById('productPrice');
        const productStockSpan = document.getElementById('productStock');
        const quantityInput = document.getElementById('quantityInput');
        const addItemBtn = document.getElementById('addItemBtn');
        const billItemsContainer = document.getElementById('billItemsContainer');
        const subtotalAmountSpan = document.getElementById('subtotalAmount');
        const discountAmountInput = document.getElementById('discountAmountInput');
        const totalAmountSpan = document.getElementById('totalAmount');
        const clearBillBtn = document.getElementById('clearBillBtn');
        const checkoutBtn = document.getElementById('checkoutBtn');
        const finalizeModal = document.getElementById('finalizeModal');
        const modalTotalSpan = document.getElementById('modalTotal');
        const amountPaidInput = document.getElementById('amountPaidInput');
        const newBillBtn = document.getElementById('newBillBtn');
        const loanAmountSpan = document.getElementById('loanAmount');
        const customerNameInput = document.getElementById('customerNameInput');
        const customerPhoneInput = document.getElementById('customerPhoneInput');
        const sendWhatsappBtn = document.getElementById('sendWhatsappBtn');
        const userIdDisplay = document.getElementById('userIdDisplay');

        // Customer UI references
        const customerSearchSection = document.getElementById('customerSearchSection');
        const customerSearchInput = document.getElementById('customerSearch');
        const customerSearchResultsList = document.getElementById('customerSearchResults');
        const manualCustomerToggleBtn = document.getElementById('manualCustomerToggleBtn');
        const manualCustomerSection = document.getElementById('manualCustomerSection');
        const manualCustomerNameInput = document.getElementById('manualCustomerNameInput');
        const manualCustomerPhoneInput = document.getElementById('manualCustomerPhoneInput');
        const addManualCustomerBtn = document.getElementById('addManualCustomerBtn');
        const manualCustomerCancelBtn = document.getElementById('manualCustomerCancelBtn');

        // Product UI references
        const manualAddToggleBtn = document.getElementById('manualAddToggleBtn');
        const manualAddSection = document.getElementById('manualAddSection');
        const productSearchSection = document.getElementById('productSearchSection');
        const manualProductNameInput = document.getElementById('manualProductName');
        const manualProductPriceInput = document.getElementById('manualProductPrice');
        const manualQuantityInput = document.getElementById('manualQuantity');
        const addManualItemBtn = document.getElementById('addManualItemBtn');
        const manualAddCancelBtn = document.getElementById('manualAddCancelBtn');

        // Functions for UI rendering and logic
        const calculateTotals = () => {
            const subtotal = billItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const discount = parseFloat(discountAmountInput.value) || 0;
            const total = Math.max(0, subtotal - discount);

            subtotalAmountSpan.textContent = `Rs ${subtotal.toFixed(2)}`;
            totalAmountSpan.textContent = `Rs ${total.toFixed(2)}`;
            modalTotalSpan.textContent = `Rs ${total.toFixed(2)}`;
            updateLoanAmount();
        };

        const renderBill = () => {
            billItemsContainer.innerHTML = '';
            if (billItems.length === 0) {
                billItemsContainer.innerHTML = `<tr><td colspan="5" class="py-4 text-center text-gray-500">No items added to the bill.</td></tr>`;
            } else {
                billItems.forEach((item, index) => {
                    const subtotal = item.price * item.quantity;
                    const tr = document.createElement('tr');
                    tr.className = 'border-b border-gray-200 hover:bg-gray-100';
                    tr.innerHTML = `
                        <td class="py-3 px-6">${item.name}</td>
                        <td class="py-3 px-6">${item.quantity}</td>
                        <td class="py-3 px-6">Rs ${item.price.toFixed(2)}</td>
                        <td class="py-3 px-6 text-right font-semibold">Rs ${subtotal.toFixed(2)}</td>
                        <td class="py-3 px-6 text-right">
                            <button class="btn-remove-item text-red-500" data-index="${index}"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    `;
                    billItemsContainer.appendChild(tr);
                });
            }
            calculateTotals();
        };

        const updateLoanAmount = () => {
            const total = parseFloat(totalAmountSpan.textContent.replace('Rs ', ''));
            const paid = parseFloat(amountPaidInput.value) || 0;
            const loan = total - paid;
            loanAmountSpan.textContent = `Rs ${loan.toFixed(2)}`;
            loanAmountSpan.className = `text-lg font-bold ${loan > 0 ? 'text-red-600' : 'text-green-600'}`;
        };

        const resetBill = () => {
            billItems = [];
            productSearchInput.value = '';
            customerSearchInput.value = '';
            selectedProductDetailsDiv.classList.add('hidden');
            manualAddSection.classList.add('hidden');
            productSearchSection.classList.remove('hidden');
            manualCustomerSection.classList.add('hidden');
            customerSearchSection.classList.remove('hidden');
            amountPaidInput.value = '';
            customerNameInput.value = '';
            customerPhoneInput.value = '';
            discountAmountInput.value = 0;
            renderBill();
        };

        const finalizeBill = async () => {
            if (billItems.length === 0) {
                showAlert("Please add items to the bill before checking out.", 'error');
                return;
            }

            const totalAmount = parseFloat(totalAmountSpan.textContent.replace('Rs ', ''));
            const subtotalAmount = parseFloat(subtotalAmountSpan.textContent.replace('Rs ', ''));
            const discountAmount = parseFloat(discountAmountInput.value) || 0;
            const amountPaid = parseFloat(amountPaidInput.value) || 0;
            const customerName = customerNameInput.value.trim() || 'Guest';
            const customerPhone = customerPhoneInput.value.trim();
            const timestamp = new Date();

            let loanAmount = 0;
            let status = 'Paid';

            if (amountPaid < totalAmount) {
                loanAmount = totalAmount - amountPaid;
                status = 'Partially Paid';
            } else if (amountPaid === totalAmount) {
                status = 'Paid';
            } else {
                status = 'Overpaid';
            }
            
            try {
                // Use a Firestore transaction to ensure atomic operations
                await runTransaction(db, async (transaction) => {
                    const salesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/sales`);
                    const stockCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/stock`);
                    const customersCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/customers`);

                    // Check if customer exists and add if not
                    if (customerName && customerPhone) {
                        const existingCustomer = allCustomers.find(c => c.phone === customerPhone);
                        if (!existingCustomer) {
                            await addDoc(customersCollectionRef, {
                                name: customerName,
                                phone: customerPhone
                            });
                        }
                    }

                    // Add the sale record
                    await addDoc(salesCollectionRef, {
                        items: billItems,
                        subtotal: subtotalAmount,
                        discount: discountAmount,
                        total: totalAmount,
                        amountPaid: amountPaid,
                        loanAmount: loanAmount,
                        customerName: customerName,
                        customerPhone: customerPhone,
                        status: status,
                        timestamp: timestamp
                    });

                    // Update product stock within the same transaction
                    for (const item of billItems) {
                        // Only update stock for items that have a product ID (not manually added)
                        if (item.id) {
                            const productRef = doc(stockCollectionRef, item.id);
                            const productDoc = await transaction.get(productRef);
                            if (!productDoc.exists()) {
                                throw new Error(`Product with ID ${item.id} not found.`);
                            }
                            const newStock = productDoc.data().stock - item.quantity;
                            if (newStock < 0) {
                                throw new Error(`Not enough stock for ${item.name}. Available: ${productDoc.data().stock}`);
                            }
                            transaction.update(productRef, { stock: newStock });
                        }
                    }
                });

                showAlert("Bill finalized and stock updated successfully!", 'success');
                finalizeModal.classList.add('hidden');
                
                // If a phone number is provided, send the WhatsApp message
                if (customerPhone) {
                    sendWhatsAppMessage({
                        customerName,
                        customerPhone,
                        total: totalAmount,
                        amountPaid: amountPaid,
                        loanAmount: loanAmount
                    });
                }
                resetBill();
            } catch (error) {
                console.error("Transaction failed: ", error);
                showAlert(`Transaction failed: ${error.message}`, 'error');
            }
        };

        const sendWhatsAppMessage = (data) => {
            const total = data.total.toFixed(2);
            const paid = data.amountPaid.toFixed(2);
            const loan = data.loanAmount.toFixed(2);
            
            // Add Sri Lankan country code if not present
            let phoneNumber = data.customerPhone.replace(/^0/, ''); // Remove leading 0 if present
            if (!phoneNumber.startsWith('94')) {
                phoneNumber = '94' + phoneNumber;
            }

            let message = `Welcome to Smile & Supplies!ðŸ›’\n\nWe offer a variety of online products, including kitchen accessories, home essentials, kids' items, and stationery.\n\nHello ${data.customerName}, here is your bill summary:\n\nTotal: Rs ${total}\nAmount Paid: Rs ${paid}`;
            if (data.loanAmount > 0) {
                message += `\nRemaining Loan: Rs ${loan}`;
            }
            message += `\n\nThank you for your business!\n\nðŸ“ž Contact: 0764950844\nðŸ“§ Email: smileandsupplier@outlook.com\n\nExplore, shop, and enjoy quality products at affordable prices. Feel free to reach out for inquiries or orders!"\n\n**Follow this link to join my WhatsApp group: https://chat.whatsapp.com/K7ALigMk9ad4SBlcRUqoxX`;

            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
        };

        // Utility functions for UI alerts
        function showAlert(message, type = 'success', duration = 3000) {
            const alertContainer = document.getElementById('alert-container');
            const alertDiv = document.createElement('div');
            alertDiv.className = `custom-alert p-4 rounded-lg shadow-md mb-2 text-white font-bold animate-fade-in-up ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
            alertDiv.textContent = message;
            alertContainer.appendChild(alertDiv);
            setTimeout(() => {
                alertDiv.remove();
            }, duration);
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Firebase Initialization
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = `User ID: ${userId}`;
                    isAuthReady = true;
                    // Listen for real-time stock changes
                    const productsCollectionPath = `artifacts/${appId}/users/${userId}/stock`;
                    onSnapshot(collection(db, productsCollectionPath), (snapshot) => {
                        allProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        console.log("Stock data loaded:", allProducts);
                    });
                    // Listen for real-time customer changes
                    const customersCollectionPath = `artifacts/${appId}/users/${userId}/customers`;
                    onSnapshot(collection(db, customersCollectionPath), (snapshot) => {
                        allCustomers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    });
                } else {
                    userId = null;
                    userIdDisplay.textContent = `User ID: Not authenticated`;
                    isAuthReady = false;
                    await signInAnonymously(auth);
                }
            });

            // Customer search and selection logic
            customerSearchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                customerSearchResultsList.innerHTML = '';
                if (query.length > 0) {
                    const filtered = allCustomers.filter(c => 
                        c.name.toLowerCase().includes(query) || c.phone.includes(query)
                    );
                    if (filtered.length > 0) {
                        customerSearchResultsList.classList.remove('hidden');
                        filtered.forEach(customer => {
                            const li = document.createElement('li');
                            li.className = 'p-2 hover:bg-gray-100 cursor-pointer';
                            li.textContent = `${customer.name} (${customer.phone})`;
                            li.addEventListener('click', () => {
                                customerNameInput.value = customer.name;
                                customerPhoneInput.value = customer.phone;
                                customerSearchResultsList.classList.add('hidden');
                                customerSearchInput.value = customer.name;
                            });
                            customerSearchResultsList.appendChild(li);
                        });
                    } else {
                        customerSearchResultsList.classList.add('hidden');
                    }
                } else {
                    customerSearchResultsList.classList.add('hidden');
                }
            });

            // Toggle between customer search and manual add modes
            manualCustomerToggleBtn.addEventListener('click', () => {
                customerSearchSection.classList.add('hidden');
                manualCustomerSection.classList.remove('hidden');
            });
            manualCustomerCancelBtn.addEventListener('click', () => {
                manualCustomerSection.classList.add('hidden');
                customerSearchSection.classList.remove('hidden');
                manualCustomerNameInput.value = '';
                manualCustomerPhoneInput.value = '';
            });

            // Add new customer manually
            addManualCustomerBtn.addEventListener('click', async () => {
                const name = manualCustomerNameInput.value.trim();
                const phone = manualCustomerPhoneInput.value.trim();

                if (!name || !phone) {
                    showAlert('Please enter both customer name and phone number.', 'error');
                    return;
                }
                
                // Add Sri Lankan country code if not present
                let formattedPhone = phone.replace(/^0/, ''); // Remove leading 0 if present
                if (!formattedPhone.startsWith('94')) {
                    formattedPhone = '94' + formattedPhone;
                }

                try {
                    const customersCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/customers`);
                    await addDoc(customersCollectionRef, {
                        name: name,
                        phone: formattedPhone
                    });
                    showAlert("Customer added successfully!", 'success');
                    
                    // Auto-fill the customer details on the bill
                    customerNameInput.value = name;
                    customerPhoneInput.value = formattedPhone;

                    manualCustomerSection.classList.add('hidden');
                    customerSearchSection.classList.remove('hidden');
                    manualCustomerNameInput.value = '';
                    manualCustomerPhoneInput.value = '';
                } catch (error) {
                    console.error("Error adding customer:", error);
                    showAlert("Failed to add customer. Please try again.", 'error');
                }
            });

            // Toggle between product search and manual add modes
            manualAddToggleBtn.addEventListener('click', () => {
                productSearchSection.classList.add('hidden');
                manualAddSection.classList.remove('hidden');
                selectedProductDetailsDiv.classList.add('hidden');
            });
            manualAddCancelBtn.addEventListener('click', () => {
                manualAddSection.classList.add('hidden');
                productSearchSection.classList.remove('hidden');
                manualProductNameInput.value = '';
                manualProductPriceInput.value = '';
                manualQuantityInput.value = 1;
            });

            // Product search and add logic
            productSearchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                searchResultsList.innerHTML = '';
                if (query.length > 0) {
                    const filtered = allProducts.filter(p => p.name.toLowerCase().includes(query) && p.stock > 0);
                    if (filtered.length > 0) {
                        searchResultsList.classList.remove('hidden');
                        filtered.forEach(product => {
                            const li = document.createElement('li');
                            li.className = 'p-2 hover:bg-gray-100 cursor-pointer';
                            li.textContent = `${product.name} (Rs ${product.price.toFixed(2)}) - ${product.stock} in stock`;
                            li.addEventListener('click', () => {
                                productNameSpan.textContent = product.name;
                                productPriceSpan.textContent = product.price.toFixed(2);
                                productStockSpan.textContent = product.stock;
                                quantityInput.value = 1;
                                selectedProductDetailsDiv.classList.remove('hidden');
                                searchResultsList.classList.add('hidden');
                                productSearchInput.value = '';
                                selectedProductDetailsDiv.dataset.productId = product.id;
                            });
                            searchResultsList.appendChild(li);
                        });
                    } else {
                        searchResultsList.classList.add('hidden');
                    }
                } else {
                    searchResultsList.classList.add('hidden');
                }
            });

            addItemBtn.addEventListener('click', () => {
                const productId = selectedProductDetailsDiv.dataset.productId;
                const quantity = parseInt(quantityInput.value);
                const product = allProducts.find(p => p.id === productId);

                if (!product || quantity <= 0) {
                    showAlert('Please select a product and enter a valid quantity.', 'error');
                    return;
                }

                if (quantity > product.stock) {
                    showAlert(`Not enough stock. Only ${product.stock} available.`, 'error');
                    return;
                }
                
                const existingItemIndex = billItems.findIndex(item => item.id === productId);
                if (existingItemIndex !== -1) {
                    billItems[existingItemIndex].quantity += quantity;
                } else {
                    billItems.push({
                        id: productId,
                        name: product.name,
                        price: product.price,
                        quantity: quantity
                    });
                }
                showAlert(`${quantity} x ${product.name} added to bill.`, 'success');
                selectedProductDetailsDiv.classList.add('hidden');
                renderBill();
            });

            addManualItemBtn.addEventListener('click', () => {
                const name = manualProductNameInput.value.trim();
                const price = parseFloat(manualProductPriceInput.value);
                const quantity = parseInt(manualQuantityInput.value);

                if (!name || isNaN(price) || price <= 0 || isNaN(quantity) || quantity <= 0) {
                    showAlert('Please enter a valid name, price, and quantity.', 'error');
                    return;
                }

                billItems.push({
                    name: name,
                    price: price,
                    quantity: quantity
                });

                showAlert(`${quantity} x ${name} added to bill.`, 'success');
                manualProductNameInput.value = '';
                manualProductPriceInput.value = '';
                manualQuantityInput.value = 1;
                renderBill();
            });

            // Bill item removal
            billItemsContainer.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.btn-remove-item');
                if (removeBtn) {
                    const index = removeBtn.dataset.index;
                    billItems.splice(index, 1);
                    showAlert('Item removed from bill.', 'success');
                    renderBill();
                }
            });

            clearBillBtn.addEventListener('click', () => {
                resetBill();
                showAlert('Bill cleared.', 'success');
            });

            checkoutBtn.addEventListener('click', () => {
                if (billItems.length === 0) {
                    showAlert('Please add items to checkout.', 'error');
                    return;
                }
                finalizeModal.classList.remove('hidden');
                amountPaidInput.value = parseFloat(totalAmountSpan.textContent.replace('Rs ', ''));
                updateLoanAmount();
            });

            // Modal logic
            amountPaidInput.addEventListener('input', updateLoanAmount);
            discountAmountInput.addEventListener('input', calculateTotals);
            newBillBtn.addEventListener('click', () => {
                finalizeModal.classList.add('hidden');
                resetBill();
            });
            sendWhatsappBtn.addEventListener('click', finalizeBill);
        });
    </script>
</body>
</html>
