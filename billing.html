<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WR Smile | Billing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(145deg, #f0f4f8, #d9e2ec);
            color: #334155;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 1100px;
        }
        .card {
            background-color: #ffffff;
            border-radius: 1.5rem;
            padding: 2.5rem;
            box-shadow: 10px 10px 20px rgba(0, 0, 0, 0.05);
        }
        .btn {
            border-radius: 9999px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn:hover {
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        .text-shadow-sm {
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }
        .table-container {
            overflow-x: auto;
        }

        /* Custom Modal Styling */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 2.5rem;
            border-radius: 1.5rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            position: relative;
            transform: scale(0.9);
            opacity: 0;
            animation: modal-fade-in 0.3s forwards;
        }
        @keyframes modal-fade-in {
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            cursor: pointer;
            color: #9ca3af;
            transition: color 0.2s;
        }
        .modal-close-btn:hover {
            color: #4b5563;
        }
        
        /* Custom Loader */
        .loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3b82f6;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom Alerts */
        #alert-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .custom-alert {
            animation: fade-in-up 0.5s ease-out forwards;
        }
        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">
    <div id="alert-container"></div>
    <div id="page-loader" class="loader-container hidden">
        <div class="loader"></div>
    </div>
    
    <!-- Main Content Area -->
    <div class="container mx-auto mt-10 p-4">
        <div class="card p-8 md:p-12 mb-8">
            <h1 class="text-4xl md:text-5xl font-extrabold text-center mb-4 text-gray-800">
                Billing
            </h1>
            <p class="text-center text-lg md:text-xl text-gray-600 mb-8">
                Create new bills and manage your transactions.
            </p>

            <div class="flex justify-between items-center mb-6">
                <div class="bg-gray-100 px-4 py-2 rounded-full font-medium text-gray-500 text-sm">
                    User ID: <span id="userIdDisplay" class="font-mono text-gray-700">Loading...</span>
                </div>
                <button id="addNewProductBtn" class="btn bg-gray-200 text-gray-700 hover:bg-gray-300 px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-gray-400">
                    <i class="fas fa-plus-circle mr-2"></i> Add New Product
                </button>
            </div>

            <!-- Customer Details Form -->
            <div class="bg-white rounded-xl shadow p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Customer Details</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="customerName" class="block text-gray-700 font-medium mb-2">Customer Name</label>
                        <input type="text" id="customerName" placeholder="e.g. John Doe" class="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                    </div>
                    <div>
                        <label for="customerArea" class="block text-gray-700 font-medium mb-2">Customer Area</label>
                        <input type="text" id="customerArea" placeholder="e.g. Colombo" class="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                    </div>
                    <div>
                        <label for="customerPhone" class="block text-gray-700 font-medium mb-2">Phone Number</label>
                        <input type="tel" id="customerPhone" value="+94" placeholder="e.g. +94771234567" class="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                    </div>
                </div>
            </div>

            <!-- New Bill Item Form -->
            <div class="bg-white rounded-xl shadow p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Add Items to Bill</h2>
                <div class="flex justify-end mb-4">
                    <button id="toggleManualAddBtn" class="btn bg-gray-200 text-gray-700 hover:bg-gray-300 px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-gray-400">
                        <i class="fas fa-plus mr-2"></i> Add Custom Item
                    </button>
                </div>
                <!-- Product Selection Section -->
                <div id="productSelectSection" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div class="md:col-span-2">
                        <label for="productSelect" class="block text-gray-700 font-medium mb-2">Select Product</label>
                        <select id="productSelect" class="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                            <option value="">-- Loading Products --</option>
                        </select>
                    </div>
                    <div>
                        <label for="itemQuantity" class="block text-gray-700 font-medium mb-2">Quantity</label>
                        <input type="number" id="itemQuantity" value="1" min="1" class="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                    </div>
                </div>

                <!-- Manual Product Entry Section (Hidden by default) -->
                <div id="manualProductSection" class="hidden grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <div class="md:col-span-2">
                        <label for="manualProductName" class="block text-gray-700 font-medium mb-2">Custom Product Name</label>
                        <input type="text" id="manualProductName" placeholder="e.g. New Item" class="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                    </div>
                    <div>
                        <label for="manualProductPrice" class="block text-gray-700 font-medium mb-2">Unit Price (LKR)</label>
                        <input type="number" id="manualProductPrice" placeholder="0.00" step="0.01" class="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                    </div>
                    <div>
                        <label for="manualProductQuantity" class="block text-gray-700 font-medium mb-2">Quantity</label>
                        <input type="number" id="manualProductQuantity" value="1" min="1" class="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                    </div>
                </div>

                <div class="mt-4 flex justify-end">
                    <button id="addItemBtn" class="btn bg-green-600 text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 px-6 py-3 disabled:bg-gray-400 disabled:cursor-not-allowed">
                        <i class="fas fa-cart-plus mr-2"></i> Add Item
                    </button>
                </div>
            </div>

            <!-- Bill Table -->
            <div class="bg-white rounded-xl shadow overflow-hidden mb-6 table-container">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Qty</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit Price (LKR)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subtotal (LKR)</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="billTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Bill items will be inserted here -->
                    </tbody>
                </table>
            </div>
            
            <p id="noItemsMessage" class="text-center text-gray-500 mt-8 hidden">Add an item to the bill to get started!</p>

            <!-- Totals and Finalize Section -->
            <div class="bg-white rounded-xl shadow p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-4">
                        <div class="flex justify-between items-center text-xl font-bold">
                            <span class="text-gray-600">Total Price:</span>
                            <span id="totalPriceDisplay" class="text-gray-800">LKR 0.00</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <label for="discountAmount" class="text-gray-600 font-medium">Discount (LKR):</label>
                            <input type="number" id="discountAmount" value="0" min="0" class="w-32 text-right px-2 py-1 border rounded-full">
                        </div>
                        <div class="flex justify-between items-center text-xl font-bold">
                            <span class="text-gray-600">Grand Total:</span>
                            <span id="grandTotalDisplay" class="text-gray-800">LKR 0.00</span>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <label for="amountPaid" class="text-gray-600 font-medium">Amount Paid (LKR):</label>
                            <input type="number" id="amountPaid" value="0" min="0" class="w-32 text-right px-2 py-1 border rounded-full">
                        </div>
                        <div class="flex justify-between items-center text-lg font-bold">
                            <span class="text-gray-600">Loan Amount:</span>
                            <span id="loanAmountDisplay" class="text-red-600">LKR 0.00</span>
                        </div>
                        <button id="finalizeBillBtn" class="w-full btn bg-blue-600 text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 px-6 py-3 disabled:bg-gray-400 disabled:cursor-not-allowed">
                            <i class="fas fa-check-circle mr-2"></i> Finalize Bill
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Finalize Modal -->
    <div id="finalizeModal" class="modal-overlay hidden">
        <div class="modal-content text-center">
            <h3 class="text-2xl font-bold mb-4 text-gray-800">Bill Finalized!</h3>
            <p class="text-gray-600 mb-6">Your transaction has been recorded.</p>
            <div class="flex flex-col md:flex-row gap-4 justify-center">
                <button id="newBillBtn" class="btn bg-blue-600 text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 px-6 py-3">
                    <i class="fas fa-file-alt mr-2"></i> New Bill
                </button>
                <button id="whatsappBillBtn" class="btn bg-green-500 text-white hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400 px-6 py-3">
                    <i class="fab fa-whatsapp mr-2"></i> Send via WhatsApp
                </button>
            </div>
        </div>
    </div>
    
    <!-- Add Product Modal -->
    <div id="addProductModal" class="modal-overlay hidden">
        <div class="modal-content text-center">
            <button id="closeProductModalBtn" class="modal-close-btn">
                <i class="fas fa-times text-2xl"></i>
            </button>
            <h3 class="text-2xl font-bold mb-4 text-gray-800">Add New Product</h3>
            <form id="addProductForm">
                <div class="space-y-4">
                    <div>
                        <label for="productName" class="block text-gray-700 font-medium mb-2 text-left">Product Name</label>
                        <input type="text" id="productName" name="productName" class="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors" required>
                    </div>
                    <div>
                        <label for="productUnitPrice" class="block text-gray-700 font-medium mb-2 text-left">Unit Price (LKR)</label>
                        <input type="number" id="productUnitPrice" name="productUnitPrice" min="0" step="0.01" class="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors" required>
                    </div>
                    <div>
                        <label for="productUnitCost" class="block text-gray-700 font-medium mb-2 text-left">Unit Cost (LKR)</label>
                        <input type="number" id="productUnitCost" name="productUnitCost" min="0" step="0.01" class="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors" required>
                    </div>
                    <div>
                        <label for="productQuantity" class="block text-gray-700 font-medium mb-2 text-left">Quantity</label>
                        <input type="number" id="productQuantity" name="productQuantity" min="0" class="w-full px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors" required>
                    </div>
                </div>
                <button type="submit" class="w-full btn bg-blue-600 text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 px-6 py-3 mt-6">
                    <i class="fas fa-save mr-2"></i> Save Product
                </button>
            </form>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Use the globally provided variables as per the instructions
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfigRaw = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db;
        let auth;
        let userId;
        let productsCollectionRef;
        let salesCollectionRef;
        
        let products = [];
        let productsMap = {}; // A map for quick lookup by name
        let billItems = [];
        let latestFinalizedBill = null;
        let isManualMode = false;

        // --- UI Element References ---
        const customerNameInput = document.getElementById('customerName');
        const customerAreaInput = document.getElementById('customerArea');
        const customerPhoneInput = document.getElementById('customerPhone');
        const addNewProductBtn = document.getElementById('addNewProductBtn');
        const productSelectSection = document.getElementById('productSelectSection');
        const productSelect = document.getElementById('productSelect');
        const itemQuantityInput = document.getElementById('itemQuantity');
        const manualProductSection = document.getElementById('manualProductSection');
        const manualProductNameInput = document.getElementById('manualProductName');
        const manualProductPriceInput = document.getElementById('manualProductPrice');
        const manualProductQuantityInput = document.getElementById('manualProductQuantity');
        const toggleManualAddBtn = document.getElementById('toggleManualAddBtn');
        const addItemBtn = document.getElementById('addItemBtn');
        const billTableBody = document.getElementById('billTableBody');
        const totalPriceDisplay = document.getElementById('totalPriceDisplay');
        const discountAmountInput = document.getElementById('discountAmount');
        const grandTotalDisplay = document.getElementById('grandTotalDisplay');
        const amountPaidInput = document.getElementById('amountPaid');
        const loanAmountDisplay = document.getElementById('loanAmountDisplay');
        const finalizeBillBtn = document.getElementById('finalizeBillBtn');
        const finalizeModal = document.getElementById('finalizeModal');
        const newBillBtn = document.getElementById('newBillBtn');
        const whatsappBillBtn = document.getElementById('whatsappBillBtn');
        const noItemsMessage = document.getElementById('noItemsMessage');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const loader = document.getElementById('page-loader');
        const addProductModal = document.getElementById('addProductModal');
        const closeProductModalBtn = document.getElementById('closeProductModalBtn');
        const addProductForm = document.getElementById('addProductForm');

        // --- Utility Functions ---
        function showMessage(message, type = 'success', duration = 3000) {
            const alertContainer = document.getElementById('alert-container');
            const alertDiv = document.createElement('div');
            alertDiv.className = `custom-alert p-4 rounded-lg shadow-md mb-2 text-white font-bold animate-fade-in-up ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
            alertDiv.textContent = message;
            alertContainer.appendChild(alertDiv);
            setTimeout(() => {
                alertDiv.remove();
            }, duration);
        }

        function showLoader() {
            loader.classList.remove('hidden');
        }

        function hideLoader() {
            loader.classList.add('hidden');
        }

        function showCustomModal(modal) {
            modal.classList.remove('hidden');
        }

        function hideCustomModal(modal) {
            modal.classList.add('hidden');
        }

        // --- Firebase Authentication ---
        async function authenticate() {
            try {
                const firebaseConfig = JSON.parse(firebaseConfigRaw);
                console.log("Firebase Config:", firebaseConfig);
                if (Object.keys(firebaseConfig).length === 0) {
                     // This is the explicit check for the invalid-api-key issue.
                    throw new Error("Firebase configuration is empty. Please check your environment settings.");
                }
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                setLogLevel('debug');

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                userId = auth.currentUser.uid;
                userIdDisplay.textContent = userId;
                
                productsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/products`);
                salesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/sales`);
                
                console.log("Firebase authenticated. User ID:", userId);
                console.log("Products Collection Path:", `artifacts/${appId}/users/${userId}/products`);
                console.log("Sales Collection Path:", `artifacts/${appId}/users/${userId}/sales`);
                
                startRealtimeListeners();

            } catch (error) {
                console.error("Authentication Error:", error);
                showMessage('Failed to authenticate: ' + error.message, 'error');
            }
        }
        
        // --- Real-time Data Listeners ---
        function startRealtimeListeners() {
            // Listen for changes in the products collection to keep the dropdown updated
            onSnapshot(productsCollectionRef, (snapshot) => {
                products = [];
                productsMap = {};
                if (snapshot.empty) {
                    productSelect.innerHTML = '<option value="">-- No Products Found --</option>';
                    return;
                }
                
                productSelect.innerHTML = '<option value="">Select a Product</option>';
                snapshot.forEach((doc) => {
                    const productData = { id: doc.id, ...doc.data() };
                    products.push(productData);
                    productsMap[productData.name] = productData;
                    const option = document.createElement('option');
                    option.value = productData.name;
                    option.textContent = `${productData.name} (Qty: ${productData.quantity})`;
                    productSelect.appendChild(option);
                });
                console.log("Products data updated.");
            }, (error) => {
                console.error("Error fetching products:", error);
                showMessage('Failed to load products: ' + error.message, 'error');
            });
        }
        
        // --- Bill Management Functions ---
        
        function calculateTotals() {
            let total = billItems.reduce((sum, item) => sum + item.subtotal, 0);
            const discount = parseFloat(discountAmountInput.value) || 0;
            const grandTotal = total - discount;
            const amountPaid = parseFloat(amountPaidInput.value) || 0;
            const loanAmount = grandTotal > amountPaid ? grandTotal - amountPaid : 0;
            
            totalPriceDisplay.textContent = `LKR ${total.toFixed(2)}`;
            grandTotalDisplay.textContent = `LKR ${grandTotal.toFixed(2)}`;
            loanAmountDisplay.textContent = `LKR ${loanAmount.toFixed(2)}`;
            
            finalizeBillBtn.disabled = billItems.length === 0;
        }
        
        function renderBill() {
            billTableBody.innerHTML = '';
            if (billItems.length === 0) {
                noItemsMessage.classList.remove('hidden');
            } else {
                noItemsMessage.classList.add('hidden');
            }
            
            billItems.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.quantity}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">LKR ${item.unitPrice.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">LKR ${item.subtotal.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium text-center">
                        <button class="text-red-600 hover:text-red-900 mx-2 remove-item-btn" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                billTableBody.appendChild(row);
            });
            
            document.querySelectorAll('.remove-item-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.dataset.index, 10);
                    if (isNaN(index)) return;
                    billItems.splice(index, 1);
                    renderBill();
                    calculateTotals();
                });
            });
            
            calculateTotals();
        }
        
        function resetBill() {
            billItems = [];
            itemQuantityInput.value = 1;
            discountAmountInput.value = 0;
            amountPaidInput.value = 0;
            customerNameInput.value = '';
            customerAreaInput.value = '';
            customerPhoneInput.value = '+94';
            latestFinalizedBill = null;
            if (isManualMode) toggleManualAdd(); // Switch back to default mode if needed
            renderBill();
        }

        async function updateProductQuantity(productId, soldQuantity) {
            const productRef = doc(db, productsCollectionRef.path, productId);
            try {
                const productSnapshot = await getDoc(productRef);
                if (productSnapshot.exists()) {
                    const currentQuantity = productSnapshot.data().quantity;
                    const newQuantity = currentQuantity - soldQuantity;
                    if (newQuantity >= 0) {
                        await updateDoc(productRef, { quantity: newQuantity });
                        console.log(`Updated quantity for product ${productId}.`);
                        return true;
                    } else {
                        showMessage(`Not enough stock for ${productSnapshot.data().name}. Only ${currentQuantity} available.`, 'error');
                        return false;
                    }
                } else {
                    showMessage(`Product with ID ${productId} not found in stock.`, 'error');
                    return false;
                }
            } catch (error) {
                console.error("Error updating product quantity:", error);
                showMessage('Failed to update stock quantity: ' + error.message, 'error');
                return false;
            }
        }
        
        async function finalizeBill() {
            if (billItems.length === 0) {
                showMessage("The bill is empty. Please add items.", "error");
                return;
            }
            
            const customerName = customerNameInput.value.trim();
            const customerArea = customerAreaInput.value.trim();
            const customerPhone = customerPhoneInput.value.trim();
            if (!customerName || !customerArea || !customerPhone || customerPhone.length < 5) {
                showMessage("Please enter all customer details (Name, Area, Phone Number with at least 5 digits).", "error");
                return;
            }

            showLoader();
            
            // Validate stock levels before saving
            for (const item of billItems) {
                // Only validate stock if the item is not a manual entry
                if (item.id) {
                    const stockProduct = productsMap[item.name];
                    if (!stockProduct || stockProduct.quantity < item.quantity) {
                        showMessage(`Not enough stock for ${item.name}.`, 'error');
                        hideLoader();
                        return;
                    }
                }
            }
            
            const saleData = {
                timestamp: new Date().toISOString(),
                customerName: customerName,
                customerArea: customerArea,
                customerPhone: customerPhone,
                totalPrice: parseFloat(totalPriceDisplay.textContent.replace('LKR ', '')),
                discount: parseFloat(discountAmountInput.value),
                grandTotal: parseFloat(grandTotalDisplay.textContent.replace('LKR ', '')),
                amountPaid: parseFloat(amountPaidInput.value),
                loanAmount: parseFloat(loanAmountDisplay.textContent.replace('LKR ', '')),
                items: billItems,
                userId: userId,
            };
            
            try {
                // Update stock quantities and save sale
                for (const item of billItems) {
                    if (item.id) { // Only update stock for non-manual items
                        const stockProduct = productsMap[item.name];
                        const success = await updateProductQuantity(stockProduct.id, item.quantity);
                        if (!success) {
                            hideLoader();
                            return;
                        }
                    }
                }
                
                await addDoc(salesCollectionRef, saleData);
                showMessage("Bill finalized and stock updated!", "success");
                
                latestFinalizedBill = saleData; // Save the bill data for WhatsApp
                
                hideLoader();
                showCustomModal(finalizeModal);
                
            } catch (error) {
                console.error("Error finalizing bill:", error);
                showMessage('Failed to finalize bill: ' + error.message, 'error');
                hideLoader();
            }
        }

        function sendWhatsAppMessage() {
            if (!latestFinalizedBill) {
                showMessage("No bill has been finalized yet.", "error");
                return;
            }
            
            const { customerPhone, customerName, grandTotal, loanAmount, items } = latestFinalizedBill;
            
            if (!customerPhone || customerPhone.length < 5) {
                showMessage("Customer phone number is invalid.", "error");
                return;
            }
            
            let message = `Hello ${customerName},\n\n`;
            message += `Your bill summary from WR Smile:\n\n`;
            
            items.forEach(item => {
                message += `${item.name} - Qty: ${item.quantity} - Total: LKR ${item.subtotal.toFixed(2)}\n`;
            });

            message += `\n*Grand Total:* LKR ${grandTotal.toFixed(2)}\n`;
            if (loanAmount > 0) {
                message += `*Loan Amount:* LKR ${loanAmount.toFixed(2)}\n`;
            }
            message += `\nThank you for your business!`;
            
            // Encode the message and phone number for the URL
            const encodedMessage = encodeURIComponent(message);
            const whatsappLink = `https://wa.me/${customerPhone}?text=${encodedMessage}`;
            
            // Open the WhatsApp link in a new tab
            window.open(whatsappLink, '_blank');
        }

        function toggleManualAdd() {
            isManualMode = !isManualMode;
            if (isManualMode) {
                productSelectSection.classList.add('hidden');
                manualProductSection.classList.remove('hidden');
                toggleManualAddBtn.innerHTML = `<i class="fas fa-list mr-2"></i> Select From Stock`;
                productSelect.value = '';
                itemQuantityInput.value = 1;
            } else {
                productSelectSection.classList.remove('hidden');
                manualProductSection.classList.add('hidden');
                toggleManualAddBtn.innerHTML = `<i class="fas fa-plus mr-2"></i> Add Custom Item`;
                manualProductNameInput.value = '';
                manualProductPriceInput.value = '';
                manualProductQuantityInput.value = 1;
            }
        }

        // --- Event Listeners ---
        addItemBtn.addEventListener('click', () => {
            if (isManualMode) {
                const productName = manualProductNameInput.value.trim();
                const productPrice = parseFloat(manualProductPriceInput.value);
                const quantity = parseInt(manualProductQuantityInput.value, 10);

                if (!productName || isNaN(productPrice) || isNaN(quantity) || quantity <= 0) {
                    showMessage("Please enter valid product details.", "error");
                    return;
                }

                const subtotal = productPrice * quantity;
                const item = {
                    name: productName,
                    quantity: quantity,
                    unitPrice: productPrice,
                    unitCost: 0, // Manual items have no cost
                    subtotal: subtotal
                };
                billItems.push(item);
                renderBill();

                // Reset manual inputs
                manualProductNameInput.value = '';
                manualProductPriceInput.value = '';
                manualProductQuantityInput.value = 1;
            } else {
                const selectedProduct = productSelect.value;
                const quantity = parseInt(itemQuantityInput.value, 10);
            
                if (!selectedProduct) {
                    showMessage("Please select a product.", "error");
                    return;
                }
                if (isNaN(quantity) || quantity <= 0) {
                    showMessage("Please enter a valid quantity.", "error");
                    return;
                }
            
                const product = productsMap[selectedProduct];
                if (!product || product.quantity < quantity) {
                    showMessage(`Not enough stock for ${selectedProduct}. Available: ${product ? product.quantity : 0}`, "error");
                    return;
                }
            
                const subtotal = product.unitPrice * quantity;
                const item = {
                    id: product.id,
                    name: product.name,
                    quantity: quantity,
                    unitPrice: product.unitPrice,
                    unitCost: product.unitCost,
                    subtotal: subtotal
                };
            
                billItems.push(item);
                renderBill();
            
                // Reset quantity and select after adding item
                itemQuantityInput.value = 1;
                productSelect.value = '';
            }
        });
        
        discountAmountInput.addEventListener('input', calculateTotals);
        amountPaidInput.addEventListener('input', calculateTotals);
        finalizeBillBtn.addEventListener('click', finalizeBill);
        newBillBtn.addEventListener('click', () => {
            hideCustomModal(finalizeModal);
            resetBill();
        });
        
        whatsappBillBtn.addEventListener('click', sendWhatsAppMessage);
        
        // Manual Product Add Event Listeners
        addNewProductBtn.addEventListener('click', () => showCustomModal(addProductModal));
        closeProductModalBtn.addEventListener('click', () => hideCustomModal(addProductModal));
        toggleManualAddBtn.addEventListener('click', toggleManualAdd);
        
        addProductForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const productName = document.getElementById('productName').value.trim();
            const unitPrice = parseFloat(document.getElementById('productUnitPrice').value);
            const unitCost = parseFloat(document.getElementById('productUnitCost').value);
            const quantity = parseInt(document.getElementById('productQuantity').value, 10);
            
            if (!productName || isNaN(unitPrice) || isNaN(unitCost) || isNaN(quantity)) {
                showMessage("Please fill in all product fields with valid numbers.", "error");
                return;
            }
            
            showLoader();
            try {
                await addDoc(productsCollectionRef, {
                    name: productName,
                    unitPrice: unitPrice,
                    unitCost: unitCost,
                    quantity: quantity
                });
                showMessage("Product added successfully!", "success");
                addProductForm.reset();
                hideCustomModal(addProductModal);
            } catch (error) {
                console.error("Error adding product:", error);
                showMessage('Failed to add product: ' + error.message, 'error');
            } finally {
                hideLoader();
            }
        });

        // Initial setup
        authenticate();
    </script>
</body>
</html>
