<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WR Smile | Billing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(145deg, #f0f4f8, #d9e2ec);
            color: #334155;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 1100px;
        }
        .card {
            background-color: #ffffff;
            border-radius: 1.5rem;
            padding: 2.5rem;
            box-shadow: 10px 10px 20px rgba(0, 0, 0, 0.05), -10px -10px 20px rgba(255, 255, 255, 0.5);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.6);
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 15px 15px 30px rgba(0, 0, 0, 0.07), -15px -15px 30px rgba(255, 255, 255, 0.7);
        }
        .input-group {
            position: relative;
        }
        .input-group input {
            padding-right: 2.5rem;
            box-shadow: inset 2px 2px 5px #d9e2ec, inset -2px -2px 5px #ffffff;
        }
        .input-group .icon {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
        }
        .modal {
            background-color: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
        }
        .custom-alert {
            animation: fadeInOut 3s forwards;
            font-weight: 500;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center p-4">

    <!-- Custom Alert Container -->
    <div id="alert-container" class="fixed top-5 right-5 z-50"></div>

    <!-- Main Container -->
    <div class="container mx-auto p-4 space-y-12">
        <h1 class="text-5xl font-extrabold text-center text-gray-800 font-playfair-display">Billing Dashboard</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
            <!-- Left Side: Customer & Product Input -->
            <div class="space-y-12">
                <!-- Customer Details Card -->
                <div class="card p-8">
                    <h2 class="text-3xl font-semibold mb-6 text-gray-800 font-playfair-display">Customer Details</h2>
                    <div class="space-y-6">
                        <div class="input-group">
                            <input type="text" id="customer-search" placeholder="Search by name or phone..." class="w-full px-6 py-3 border-none rounded-full focus:outline-none focus:ring-4 focus:ring-indigo-200 transition-all duration-300">
                            <i class="fas fa-search icon"></i>
                        </div>
                        <div id="customer-details-box" class="p-6 bg-gray-100 rounded-2xl hidden transition-all duration-300 shadow-inner">
                            <p class="text-lg"><strong>Name:</strong> <span id="customer-name" class="font-medium"></span></p>
                            <p class="text-lg"><strong>Phone:</strong> <span id="customer-phone" class="font-medium"></span></p>
                        </div>
                        <div class="flex items-center space-x-4">
                            <hr class="flex-grow border-gray-300">
                            <span class="text-sm text-gray-500 font-medium">OR</span>
                            <hr class="flex-grow border-gray-300">
                        </div>
                        <button id="add-customer-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-full transition-all duration-200 transform hover:scale-105 active:scale-100 shadow-lg">
                            Add New Customer
                        </button>
                    </div>
                </div>

                <!-- Manual Product Entry Card -->
                <div class="card p-8">
                    <h2 class="text-3xl font-semibold mb-6 text-gray-800 font-playfair-display">Manual Product Entry</h2>
                    <div class="space-y-6">
                        <div class="flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-4">
                            <input type="text" id="manual-product-name" placeholder="Product Name" class="flex-1 w-full px-6 py-3 border-none rounded-full focus:outline-none focus:ring-4 focus:ring-purple-200 shadow-inner transition-all duration-300">
                            <input type="number" id="manual-product-price" placeholder="Price" class="w-full md:w-36 px-6 py-3 border-none rounded-full focus:outline-none focus:ring-4 focus:ring-purple-200 shadow-inner transition-all duration-300">
                        </div>
                        <button id="add-manual-product-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-full transition-all duration-200 transform hover:scale-105 active:scale-100 shadow-lg">
                            Add Product
                        </button>
                    </div>
                </div>

                <!-- Add from Stock Card -->
                <div class="card p-8">
                    <h2 class="text-3xl font-semibold mb-6 text-gray-800 font-playfair-display">Add from Stock</h2>
                    <div class="space-y-6">
                        <div class="relative">
                            <input type="text" id="stock-product-search" placeholder="Search product in stock..." class="w-full px-6 py-3 border-none rounded-full focus:outline-none focus:ring-4 focus:ring-sky-200 shadow-inner transition-all duration-300">
                            <div id="stock-results" class="absolute z-10 w-full mt-2 bg-white border border-gray-200 rounded-xl shadow-lg max-h-48 overflow-y-auto hidden"></div>
                        </div>
                        <button id="seed-stock-btn" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-6 rounded-full transition-all duration-200 transform hover:scale-105 active:scale-100 shadow-lg">
                            Add Sample Products
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Side: Bill & Payment -->
            <div class="space-y-12">
                <!-- Bill Details Card -->
                <div class="card p-8">
                    <h2 class="text-3xl font-semibold mb-6 text-gray-800 font-playfair-display">Bill Details</h2>
                    <div class="space-y-6">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Qty</th>
                                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"></th>
                                    </tr>
                                </thead>
                                <tbody id="bill-items" class="bg-white divide-y divide-gray-200">
                                    <!-- Bill items will be added here dynamically -->
                                </tbody>
                            </table>
                        </div>
                        <div class="flex flex-col space-y-4 items-end pr-4">
                            <div class="flex justify-end items-center gap-4 text-sm font-semibold w-full">
                                <span class="text-gray-700">Subtotal:</span>
                                <span id="subtotal-amount" class="text-gray-900 font-bold">Rs 0.00</span>
                            </div>
                            <div class="flex justify-end items-center gap-4 text-sm font-semibold w-full">
                                <span class="text-gray-700">Discount Amount:</span>
                                <input type="number" id="discount-amount" value="0" class="w-32 px-4 py-2 border-none rounded-xl focus:outline-none text-right shadow-inner">
                            </div>
                            <div class="flex justify-end items-center gap-4 text-lg font-extrabold w-full">
                                <span class="text-gray-700">Total:</span>
                                <span id="total-amount" class="text-indigo-600">Rs 0.00</span>
                            </div>
                            <div class="flex justify-end items-center gap-4 text-lg font-extrabold w-full">
                                <span class="text-gray-700">Amount Paid:</span>
                                <input type="number" id="amount-paid" class="w-32 px-4 py-2 border-none rounded-xl focus:outline-none text-right shadow-inner">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Finalize Bill Card -->
                <div class="card p-8">
                    <h2 class="text-3xl font-semibold mb-6 text-gray-800 font-playfair-display">Finalize Bill</h2>
                    <div class="flex flex-col space-y-6">
                        <button id="finalize-bill-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-full transition-all duration-200 transform hover:scale-105 active:scale-100 shadow-lg">
                            Finalize Bill
                        </button>
                        <p id="bill-status" class="text-center font-bold"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- New Customer Modal -->
    <div id="new-customer-modal" class="modal fixed inset-0 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-3xl p-10 shadow-2xl max-w-lg w-full space-y-8">
            <h3 class="text-3xl font-semibold text-gray-800 font-playfair-display text-center">Add New Customer</h3>
            <input type="text" id="new-customer-name-input" placeholder="Customer Name" class="w-full px-6 py-4 border-none rounded-full focus:outline-none focus:ring-4 focus:ring-indigo-200 shadow-inner">
            <input type="tel" id="new-customer-phone-input" placeholder="Phone Number" class="w-full px-6 py-4 border-none rounded-full focus:outline-none focus:ring-4 focus:ring-indigo-200 shadow-inner">
            <div class="flex justify-between space-x-4">
                <button id="save-new-customer-btn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-full transition-all duration-200 transform hover:scale-105 active:scale-100 shadow-lg">
                    Save
                </button>
                <button id="cancel-new-customer-btn" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 rounded-full transition-all duration-200 transform hover:scale-105 active:scale-100 shadow-lg">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Finalize Modal -->
    <div id="finalize-modal" class="modal fixed inset-0 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-3xl p-10 shadow-2xl max-w-lg w-full text-center space-y-8">
            <h3 id="finalize-modal-title" class="text-3xl font-semibold text-gray-800 font-playfair-display">Bill Finalized!</h3>
            <p id="finalize-modal-text" class="text-gray-600 text-lg"></p>
            <div class="flex flex-col space-y-4">
                <button id="send-whatsapp-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-full transition-all duration-200 transform hover:scale-105 active:scale-100 shadow-lg flex items-center justify-center">
                    <i class="fab fa-whatsapp mr-2"></i> Send on WhatsApp
                </button>
                <button id="new-bill-btn" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-4 rounded-full transition-all duration-200 transform hover:scale-105 active:scale-100 shadow-lg">
                    New Bill
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, query, where, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'wr-smile-billing-app';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = 'anonymous';
        let currentCustomer = null;
        let billItems = [];
        let stockItems = [];

        // UI elements
        const customerSearchInput = document.getElementById('customer-search');
        const customerDetailsBox = document.getElementById('customer-details-box');
        const customerNameSpan = document.getElementById('customer-name');
        const customerPhoneSpan = document.getElementById('customer-phone');
        const addCustomerBtn = document.getElementById('add-customer-btn');
        const newCustomerModal = document.getElementById('new-customer-modal');
        const newCustomerNameInput = document.getElementById('new-customer-name-input');
        const newCustomerPhoneInput = document.getElementById('new-customer-phone-input');
        const saveNewCustomerBtn = document.getElementById('save-new-customer-btn');
        const cancelNewCustomerBtn = document.getElementById('cancel-new-customer-btn');
        const stockProductSearchInput = document.getElementById('stock-product-search');
        const stockResultsDiv = document.getElementById('stock-results');
        const seedStockBtn = document.getElementById('seed-stock-btn');
        const manualProductNameInput = document.getElementById('manual-product-name');
        const manualProductPriceInput = document.getElementById('manual-product-price');
        const addManualProductBtn = document.getElementById('add-manual-product-btn');
        const billItemsTable = document.getElementById('bill-items');
        const subtotalAmountSpan = document.getElementById('subtotal-amount');
        const discountAmountInput = document.getElementById('discount-amount');
        const totalAmountSpan = document.getElementById('total-amount');
        const amountPaidInput = document.getElementById('amount-paid');
        const finalizeBillBtn = document.getElementById('finalize-bill-btn');
        const finalizeModal = document.getElementById('finalize-modal');
        const finalizeModalTitle = document.getElementById('finalize-modal-title');
        const finalizeModalText = document.getElementById('finalize-modal-text');
        const sendWhatsAppBtn = document.getElementById('send-whatsapp-btn');
        const newBillBtn = document.getElementById('new-bill-btn');

        // Initialize Firebase
        const initFirebase = async () => {
            try {
                if (!firebaseConfig.projectId) {
                    showAlert("Firebase config is missing projectId.", "error");
                    console.error("Firebase config is not set. Please ensure __firebase_config is correctly provided.");
                    return;
                }

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('debug'); // Enable debug logging for troubleshooting

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log(`User signed in with ID: ${userId}`);
                        showAlert("Firebase initialized successfully!", "success");
                        fetchStockItems();
                    } else {
                        console.log("No user is signed in. Attempting to authenticate...");
                        if (initialAuthToken) {
                            try {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } catch (e) {
                                console.error("Error signing in with custom token:", e);
                                await signInAnonymously(auth);
                            }
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });

            } catch (error) {
                showAlert(`Firebase initialization failed: ${error.message}`, "error");
                console.error("Firebase initialization failed:", error);
            }
        };

        // Customer Functions
        const searchCustomer = async (queryText) => {
            if (!db) {
                showAlert("Database not ready.", "error");
                return;
            }

            const customersCol = collection(db, `artifacts/${appId}/users/${userId}/customers`);
            let q;
            if (/\d/.test(queryText)) {
                // Search by phone number
                q = query(customersCol, where("phone", "==", queryText));
            } else {
                // Search by name
                q = query(customersCol, where("name", "==", queryText));
            }

            try {
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    const customerData = querySnapshot.docs[0].data();
                    currentCustomer = customerData;
                    customerNameSpan.textContent = customerData.name;
                    customerPhoneSpan.textContent = customerData.phone;
                    customerDetailsBox.classList.remove('hidden');
                } else {
                    currentCustomer = null;
                    customerDetailsBox.classList.add('hidden');
                    showAlert("Customer not found.", "error");
                }
            } catch (e) {
                showAlert(`Error searching customer: ${e.message}`, "error");
                console.error("Error searching customer: ", e);
            }
        };

        const addNewCustomer = async (name, phone) => {
            if (!db) {
                showAlert("Database not ready.", "error");
                return;
            }

            try {
                const customersCol = collection(db, `artifacts/${appId}/users/${userId}/customers`);
                const docRef = await addDoc(customersCol, {
                    name: name,
                    phone: phone,
                    createdAt: new Date()
                });
                currentCustomer = { name, phone, id: docRef.id };
                customerNameSpan.textContent = name;
                customerPhoneSpan.textContent = phone;
                customerDetailsBox.classList.remove('hidden');
                showAlert("New customer added successfully!", "success");
                newCustomerModal.classList.add('hidden');
            } catch (e) {
                showAlert(`Error adding customer: ${e.message}`, "error");
                console.error("Error adding customer: ", e);
            }
        };

        // Product and Bill Functions
        const fetchStockItems = () => {
            if (!db) return;
            const stockCol = collection(db, `artifacts/${appId}/users/${userId}/stock`);
            onSnapshot(stockCol, (snapshot) => {
                stockItems = [];
                snapshot.forEach(doc => {
                    stockItems.push({ id: doc.id, ...doc.data() });
                });
                console.log("Stock items fetched:", stockItems);
            }, (error) => {
                showAlert(`Error fetching stock: ${error.message}`, "error");
                console.error("Error fetching stock:", error);
            });
        };

        // Function to seed sample data into the stock collection
        const seedStockData = async () => {
            if (!db) {
                showAlert("Database not ready.", "error");
                return;
            }

            // Sample products to add
            const sampleProducts = [
                { name: 'WR T-Shirt', price: 2500, stock: 100 },
                { name: 'WR Notebook', price: 500, stock: 200 },
                { name: 'WR Pen', price: 100, stock: 500 },
                { name: 'WR Cap', price: 1200, stock: 75 },
                { name: 'WR Backpack', price: 4500, stock: 50 },
            ];

            try {
                const stockCol = collection(db, `artifacts/${appId}/users/${userId}/stock`);
                for (const product of sampleProducts) {
                    await addDoc(stockCol, product);
                }
                showAlert("Sample products added to stock!", "success");
            } catch (e) {
                showAlert(`Error adding sample products: ${e.message}`, "error");
                console.error("Error adding sample products:", e);
            }
        };

        const addProductToBill = (product) => {
            const existingItem = billItems.find(item => item.name === product.name);
            if (existingItem) {
                existingItem.qty += 1;
            } else {
                billItems.push({ ...product, qty: 1 });
            }
            renderBill();
        };

        const renderBill = () => {
            billItemsTable.innerHTML = '';
            billItems.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = "hover:bg-gray-50";
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${item.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap">Rs ${item.price.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="number" class="w-16 px-2 py-1 border rounded-md text-center shadow-inner" value="${item.qty}" data-index="${index}">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">Rs ${(item.price * item.qty).toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">
                        <button class="remove-item-btn text-red-500 hover:text-red-700 transition-colors duration-200" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                billItemsTable.appendChild(row);
            });

            calculateTotals();
        };

        const calculateTotals = () => {
            const subtotal = billItems.reduce((sum, item) => sum + item.price * item.qty, 0);
            const discount = parseFloat(discountAmountInput.value) || 0;
            const total = subtotal - discount;

            subtotalAmountSpan.textContent = `Rs ${subtotal.toFixed(2)}`;
            totalAmountSpan.textContent = `Rs ${total.toFixed(2)}`;
            amountPaidInput.value = total.toFixed(2);
        };

        const finalizeBill = async () => {
            if (!db) {
                showAlert("Database not ready.", "error");
                return;
            }
            if (!currentCustomer) {
                showAlert("Please select or add a customer first.", "error");
                return;
            }
            if (billItems.length === 0) {
                showAlert("Bill is empty.", "error");
                return;
            }
            
            const totalAmount = parseFloat(totalAmountSpan.textContent.replace('Rs ', ''));
            const amountPaid = parseFloat(amountPaidInput.value);

            let transactionType = 'sale';
            let loanAmount = 0;
            let status = 'Paid';

            if (amountPaid < totalAmount) {
                transactionType = 'loan';
                loanAmount = totalAmount - amountPaid;
                status = 'Partially Paid';
            } else if (amountPaid === totalAmount) {
                status = 'Paid';
            } else {
                status = 'Overpaid';
            }

            const transactionData = {
                customerId: currentCustomer.id,
                customerName: currentCustomer.name,
                customerPhone: currentCustomer.phone,
                items: billItems,
                subtotal: billItems.reduce((sum, item) => sum + item.price * item.qty, 0),
                discount: parseFloat(discountAmountInput.value) || 0,
                total: totalAmount,
                amountPaid: amountPaid,
                loanAmount: loanAmount,
                status: status,
                timestamp: new Date()
            };

            try {
                const billsCol = collection(db, `artifacts/${appId}/users/${userId}/bills`);
                await addDoc(billsCol, transactionData);
                showAlert("Bill finalized successfully!", "success");

                let modalText = "";
                if (transactionType === 'loan') {
                    modalText = `A loan of Rs ${loanAmount.toFixed(2)} has been created for ${currentCustomer.name}.`;
                    finalizeModalTitle.textContent = "Loan Created";
                } else {
                    modalText = `The bill for Rs ${totalAmount.toFixed(2)} has been finalized for ${currentCustomer.name}.`;
                    finalizeModalTitle.textContent = "Bill Finalized!";
                }

                finalizeModalText.textContent = modalText;
                finalizeModal.classList.remove('hidden');

                // Set up WhatsApp button link
                sendWhatsAppBtn.onclick = () => sendWhatsAppMessage(transactionData);

            } catch (e) {
                showAlert(`Error finalizing bill: ${e.message}`, "error");
                console.error("Error finalizing bill: ", e);
            }
        };

        const sendWhatsAppMessage = (data) => {
            const total = data.total.toFixed(2);
            const paid = data.amountPaid.toFixed(2);
            const loan = data.loanAmount.toFixed(2);
            let message = `Hello ${data.customerName}, here is your bill summary:\n\nTotal: Rs ${total}\nAmount Paid: Rs ${paid}`;
            if (data.loanAmount > 0) {
                message += `\nRemaining Loan: Rs ${loan}`;
            }
            message += `\n\nThank you for your business!`;
            const encodedMessage = encodeURIComponent(message);
            // Prepend the country code '94' (for Sri Lanka) to the phone number.
            const whatsappUrl = `https://wa.me/94${data.customerPhone}?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
        };

        const resetBill = () => {
            currentCustomer = null;
            billItems = [];
            customerDetailsBox.classList.add('hidden');
            customerSearchInput.value = '';
            discountAmountInput.value = '0';
            stockProductSearchInput.value = '';
            manualProductNameInput.value = '';
            manualProductPriceInput.value = '';
            renderBill();
        };

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();

            // Customer search
            customerSearchInput.addEventListener('change', (e) => {
                if (e.target.value.trim() !== '') {
                    searchCustomer(e.target.value.trim());
                }
            });

            // Add new customer via modal
            addCustomerBtn.addEventListener('click', () => {
                newCustomerModal.classList.remove('hidden');
            });
            saveNewCustomerBtn.addEventListener('click', () => {
                const name = newCustomerNameInput.value.trim();
                const phone = newCustomerPhoneInput.value.trim();
                if (name && phone) {
                    addNewCustomer(name, phone);
                } else {
                    showAlert("Please enter both name and phone number.", "error");
                }
            });
            cancelNewCustomerBtn.addEventListener('click', () => {
                newCustomerModal.classList.add('hidden');
                newCustomerNameInput.value = '';
                newCustomerPhoneInput.value = '';
            });

            // Product search from stock
            stockProductSearchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                stockResultsDiv.innerHTML = '';
                if (query.length > 0) {
                    const filteredItems = stockItems.filter(item => 
                        item.name.toLowerCase().includes(query)
                    );
                    if (filteredItems.length > 0) {
                        filteredItems.forEach(item => {
                            const resultItem = document.createElement('div');
                            resultItem.className = "px-4 py-2 cursor-pointer hover:bg-gray-200 transition-colors duration-150";
                            resultItem.textContent = `${item.name} (Rs ${item.price.toFixed(2)})`;
                            resultItem.onclick = () => {
                                addProductToBill(item);
                                stockProductSearchInput.value = '';
                                stockResultsDiv.classList.add('hidden');
                            };
                            stockResultsDiv.appendChild(resultItem);
                        });
                        stockResultsDiv.classList.remove('hidden');
                    } else {
                        stockResultsDiv.innerHTML = '<div class="px-4 py-2 text-gray-500">No products found.</div>';
                        stockResultsDiv.classList.remove('hidden');
                    }
                } else {
                    stockResultsDiv.classList.add('hidden');
                }
            });

            // Manual product add
            addManualProductBtn.addEventListener('click', () => {
                const name = manualProductNameInput.value.trim();
                const price = parseFloat(manualProductPriceInput.value);
                if (name && !isNaN(price) && price > 0) {
                    addProductToBill({ name, price });
                    manualProductNameInput.value = '';
                    manualProductPriceInput.value = '';
                } else {
                    showAlert("Please enter a valid product name and price.", "error");
                }
            });
            
            // Seed stock button
            seedStockBtn.addEventListener('click', seedStockData);

            // Bill item quantity and remove button
            billItemsTable.addEventListener('input', (e) => {
                if (e.target.tagName === 'INPUT' && e.target.type === 'number') {
                    const index = e.target.closest('input').dataset.index;
                    const newQty = parseInt(e.target.value);
                    if (!isNaN(newQty) && newQty > 0) {
                        billItems[index].qty = newQty;
                        renderBill();
                    } else {
                        // Reset to previous value if input is invalid
                        e.target.value = billItems[index].qty;
                    }
                }
            });
            billItemsTable.addEventListener('click', (e) => {
                if (e.target.closest('.remove-item-btn')) {
                    const index = e.target.closest('.remove-item-btn').dataset.index;
                    billItems.splice(index, 1);
                    renderBill();
                }
            });

            // Discount and amount paid input
            discountAmountInput.addEventListener('input', calculateTotals);
            amountPaidInput.addEventListener('input', () => {
                // This is a user-controlled field, so we don't recalculate totals based on it
                // It only impacts the loan calculation on finalization
            });

            // Finalize bill button
            finalizeBillBtn.addEventListener('click', finalizeBill);

            // Modal buttons
            newBillBtn.addEventListener('click', () => {
                finalizeModal.classList.add('hidden');
                resetBill();
            });

            // Initial render
            renderBill();
        });

        // Utility functions for UI alerts
        function showAlert(message, type = 'success', duration = 3000) {
            const alertContainer = document.getElementById('alert-container');
            const alertDiv = document.createElement('div');
            alertDiv.className = `custom-alert p-4 rounded-lg shadow-md mb-2 text-white font-bold animate-fade-in-up ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
            alertDiv.textContent = message;
            alertContainer.appendChild(alertDiv);
            setTimeout(() => {
                alertDiv.remove();
            }, duration);
        }
    </script>
</body>
</html>
