<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WR Smile - Loan Management</title>
    <!-- Your existing CSS -->
    <link rel="stylesheet" href="style.css">
    <!-- Include Firebase SDKs -->
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js"></script>
</head>
<body>
    <div id="page-loader" class="page-loader">
        <div class="spinner"></div>
    </div>

    <header class="header">
        <img src="logo.png.webp" alt="WR Smile Logo" class="logo">
        <nav class="nav">
            <a href="index.html">Dashboard</a>
            <a href="billing.html">Billing</a>
            <a href="stock.html">Stock</a>
            <a href="customers.html">Customers</a>
            <a href="loan.html" class="active">Loans</a>
        </nav>
    </header>

    <div class="container">
        <h1 class="section-title">Loan Management</h1>
        <div class="input-group">
            <input type="text" id="customer-phone-input" class="form-input" placeholder="Enter customer phone number">
            <button id="search-btn" class="btn btn-primary-custom">Search</button>
        </div>
        <h2 id="customer-name" class="customer-name-display">Search a customer to view their loans.</h2>
        <div id="customer-loans-list" class="loan-list">
            <!-- Loan cards will be loaded here -->
        </div>
        <div class="flex-container mt-6">
            <button id="add-loan-btn" class="btn btn-primary-custom">Add New Loan</button>
        </div>
    </div>
    <!-- Add Loan Modal -->
    <div id="add-loan-modal" class="modal-custom hidden">
        <div class="modal-custom-content">
            <span class="close-btn-custom" id="closeAddLoanModal">&times;</span>
            <h5 class="modal-custom-title">Add New Loan</h5>
            <form id="add-loan-form">
                <div class="form-group">
                    <label for="loan-customer-phone" class="form-label">Customer Phone</label>
                    <input type="text" id="loan-customer-phone" class="form-input" readonly required>
                </div>
                <hr class="my-4">
                <h6 class="text-lg font-semibold mb-3">Products for Loan</h6>
                <div id="loan-products-container">
                    <!-- Product rows will be dynamically added here -->
                </div>
                <button type="button" id="add-product-row-btn" class="btn btn-secondary-custom w-full mt-4">Add Product</button>
                <div class="form-group mt-4">
                    <label for="discount">Discount (Rs)</label>
                    <input type="number" id="discount" class="form-input" value="0" min="0">
                </div>
                <div class="form-group">
                    <label for="loan-note">Loan Note (Optional)</label>
                    <textarea id="loan-note" class="form-textarea" placeholder="Add any specific notes for this loan"></textarea>
                </div>
                <div class="modal-custom-footer">
                    <button type="submit" class="btn btn-primary">Save Loan</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Add Payment Modal -->
    <div id="add-payment-modal" class="modal-custom hidden">
        <div class="modal-custom-content">
            <span class="close-btn-custom" id="closeAddPaymentModal">&times;</span>
            <h5 class="modal-custom-title">Add Payment</h5>
            <form id="add-payment-form">
                <input type="hidden" id="loan-id-input">
                <div class="form-group">
                    <label for="payment-amount">Payment Amount (Rs)</label>
                    <input type="number" id="payment-amount" class="form-input" min="0" required>
                </div>
                <div class="form-group">
                    <label for="payment-note">Note (Optional)</label>
                    <textarea id="payment-note" class="form-input"></textarea>
                </div>
                <div class="modal-custom-footer">
                    <button type="submit" class="btn btn-primary">Submit Payment</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Custom Alert Container -->
    <div id="alert-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, doc, getDoc, addDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getDatabase, ref, push, set, once, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // Import the loadLoansForCustomer function
        import { loadLoansForCustomer } from './loadLoansForCustomer.js';

        // Initialize Firebase app
        const firebaseConfig = {
            apiKey: "AIzaSyACehOi7n-dbdN00D4tJr2kD_-AVR6S-Vo",
            authDomain: "wr-smile-shop.firebaseapp.com",
            databaseURL: "https://wr-smile-shop-default-rtdb.firebaseio.com",
            projectId: "wr-smile-shop",
            storageBucket: "wr-smile-shop.firebasestorage.app",
            messagingSenderId: "299864260187",
            appId: "1:299864260187:web:fa6af65ef95674aff1097e",
            measurementId: "G-3Z38G6MCYJ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const realtimeDb = getDatabase(app);

        // Firestore collections and Realtime Database references
        const customersCollection = collection(db, "customers");
        const loansRef = ref(realtimeDb, "loans");
        const paymentsRef = ref(realtimeDb, "payments");

        // DOM Elements
        const customerPhoneInput = document.getElementById('customer-phone-input');
        const customerNameDisplay = document.getElementById('customer-name');
        const loanListDiv = document.getElementById('customer-loans-list');
        const addLoanBtn = document.getElementById('add-loan-btn');
        const addLoanModal = document.getElementById('add-loan-modal');
        const addLoanForm = document.getElementById('add-loan-form');
        const loanCustomerPhoneInput = document.getElementById('loan-customer-phone');
        const loanProductsContainer = document.getElementById('loan-products-container');
        const addProductRowBtn = document.getElementById('add-product-row-btn');
        const discountInput = document.getElementById('discount');
        const loanNoteInput = document.getElementById('loan-note');

        const addPaymentModal = document.getElementById('add-payment-modal');
        const addPaymentForm = document.getElementById('add-payment-form');
        const loanIdInput = document.getElementById('loan-id-input');
        const paymentAmountInput = document.getElementById('payment-amount');
        const paymentNoteInput = document.getElementById('payment-note');

        const pageLoader = document.getElementById("page-loader");

        let currentCustomerFirestoreId = null; // To store the Firestore ID of the selected customer


        // Utility functions (from common patterns)
        function showCustomModal(modal) {
            modal.classList.add('show');
            modal.classList.remove('hidden');
        }
        function hideCustomModal(modal) {
            modal.classList.remove('show');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }
        function showAlert(message, type = 'info', duration = 3000) {
            const alertContainer = document.getElementById('alert-container');
            const alertDiv = document.createElement('div');
            alertDiv.className = `custom-alert ${type} animate-fade-in-up`;
            alertDiv.textContent = message;
            alertContainer.appendChild(alertDiv);
            setTimeout(() => {
                alertDiv.classList.remove('animate-fade-in-up');
                alertDiv.classList.add('animate-fade-out-down');
                alertDiv.addEventListener('animationend', () => alertDiv.remove());
            }, duration);
        }
        function showLoader() {
            pageLoader.classList.remove('hidden');
        }
        function hideLoader() {
            setTimeout(() => {
                pageLoader.classList.add('hidden');
            }, 300);
        }


        // --- Customer Search and Load Loans ---
        // Check for URL parameters on page load
        const urlParams = new URLSearchParams(window.location.search);
        const customerPhoneFromUrl = urlParams.get('customerPhone');

        if (customerPhoneFromUrl) {
            customerPhoneInput.value = customerPhoneFromUrl;
            searchAndLoadCustomer(customerPhoneFromUrl);
        }

        async function searchAndLoadCustomer(phone) {
            if (!phone) {
                customerNameDisplay.textContent = 'Search a customer to view their loans.';
                loanListDiv.innerHTML = '<p class="text-gray-500 text-center py-4">Search a customer to view their loans.</p>';
                currentCustomerFirestoreId = null;
                loanCustomerPhoneInput.value = ''; // Clear phone in loan modal
                addLoanBtn.disabled = true; // Disable add loan if no customer selected
                return;
            }

            showLoader();
            try {
                const q = query(customersCollection, where("phone", "==", phone));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const customerDoc = querySnapshot.docs[0];
                    const customerData = customerDoc.data();
                    currentCustomerFirestoreId = customerDoc.id; // Store Firestore ID
                    customerNameDisplay.textContent = `Customer: ${customerData.name}`;
                    loanCustomerPhoneInput.value = customerData.phone; // Set phone in loan modal
                    addLoanBtn.disabled = false; // Enable add loan button

                    // Call the function from loadLoansForCustomer.js, passing Firebase instances
                    await loadLoansForCustomer(customerData.phone, loansRef, paymentsRef, loanListDiv);
                } else {
                    customerNameDisplay.textContent = 'Customer not found.';
                    loanListDiv.innerHTML = '<p class="text-gray-500 text-center py-4">No loans found for this customer.</p>';
                    currentCustomerFirestoreId = null;
                    loanCustomerPhoneInput.value = '';
                    addLoanBtn.disabled = true;
                }
            } catch (error) {
                console.error("Error searching for customer: ", error);
                customerNameDisplay.textContent = 'Failed to load customer data.';
                loanListDiv.innerHTML = '<p class="text-danger text-center py-4">Failed to load loans.</p>';
            } finally {
                hideLoader();
            }
        }
        
        document.getElementById('search-btn').addEventListener('click', () => {
            searchAndLoadCustomer(customerPhoneInput.value.trim());
        });

        customerPhoneInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchAndLoadCustomer(customerPhoneInput.value.trim());
            }
        });

        // Initial state for add loan button
        addLoanBtn.disabled = true;


        // --- Add Loan Modal Logic ---
        addLoanBtn.addEventListener('click', () => {
            if (!currentCustomerFirestoreId) {
                showAlert("Please search and select a customer first to add a loan.", "warning");
                return;
            }
            // Clear previous products in the form
            loanProductsContainer.innerHTML = ''; 
            createProductRow(); // Start with one empty product row
            discountInput.value = '0';
            loanNoteInput.value = '';
            showCustomModal(addLoanModal);
        });

        document.getElementById('closeAddLoanModal').addEventListener('click', () => hideCustomModal(addLoanModal));

        // Dynamically add product rows to the loan form
        function createProductRow() {
            const row = document.createElement('div');
            row.className = 'product-row flex items-center gap-2 mb-2';
            row.innerHTML = `
                <input type="text" class="product-name form-input flex-grow" placeholder="Product Name" required>
                <input type="number" class="product-qty form-input w-20 text-center" placeholder="Qty" value="1" min="1" required>
                <input type="number" class="product-price form-input w-24 text-center" placeholder="Price" step="0.01" min="0" required>
                <button type="button" class="remove-product btn btn-danger btn-sm">&times;</button>
            `;
            loanProductsContainer.appendChild(row);

            row.querySelector(".remove-product").addEventListener("click", () => row.remove());
        }

        addProductRowBtn.addEventListener("click", () => createProductRow());


        // --- Save Loan Logic ---
        addLoanForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentCustomerFirestoreId) {
                showAlert("No customer selected. Please search and select a customer.", "error");
                return;
            }

            const discount = parseFloat(discountInput.value) || 0;

            const products = Array.from(loanProductsContainer.querySelectorAll('.product-row')).map(row => {
                return {
                    name: row.querySelector('.product-name').value.trim(),
                    qty: parseInt(row.querySelector('.product-qty').value),
                    price: parseFloat(row.querySelector('.product-price').value)
                };
            }).filter(p => p.name && p.qty > 0 && p.price >= 0);

            if (products.length === 0) {
                showAlert("Add at least one valid product for the loan.", "warning");
                return;
            }

            const total = products.reduce((sum, p) => sum + p.qty * p.price, 0);
            const totalAmount = total - discount;
            const loanNote = loanNoteInput.value.trim();

            if (totalAmount <= 0) {
                showAlert("Total loan amount must be greater than zero after discount.", "warning");
                return;
            }
            
            showLoader();
            try {
                // Generate a unique ID for the new loan in Realtime Database
                const newLoanRef = push(loansRef); // Using the imported push function
                await set(newLoanRef, {
                    loanId: newLoanRef.key, // Store the generated key as loanId
                    customerId: currentCustomerFirestoreId, // Link to Firestore customer ID
                    customerPhone: loanCustomerPhoneInput.value, // Also store phone for direct lookup
                    loanDate: new Date().toISOString(),
                    products: products,
                    discount: discount,
                    totalAmount: totalAmount,
                    paidAmount: 0, // Initial payment on loan is 0 for new loan
                    balance: totalAmount,
                    note: loanNote
                });
                showAlert("Loan added successfully!", "success");
                hideCustomModal(addLoanModal);
                addLoanForm.reset();
                // Reload loans for the current customer to show the new loan
                await loadLoansForCustomer(loanCustomerPhoneInput.value, loansRef, paymentsRef, loanListDiv); 
            } catch (error) {
                console.error("Error adding loan:", error);
                showAlert("Failed to add loan.", "error");
            } finally {
                hideLoader();
            }
        });


        // --- Add Payment Modal Logic ---
        loanListDiv.addEventListener('click', (e) => {
            if (e.target.classList.contains('add-payment-btn')) {
                const loanId = e.target.dataset.loanId;
                loanIdInput.value = loanId;
                paymentAmountInput.value = '';
                paymentNoteInput.value = '';
                showCustomModal(addPaymentModal);
            }
        });

        document.getElementById('closeAddPaymentModal').addEventListener('click', () => hideCustomModal(addPaymentModal));

        addPaymentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const loanId = loanIdInput.value;
            const paymentAmount = parseFloat(paymentAmountInput.value);
            const paymentNote = paymentNoteInput.value.trim();

            if (isNaN(paymentAmount) || paymentAmount <= 0) {
                showAlert("Please enter a valid payment amount.", "warning");
                return;
            }

            showLoader();
            try {
                const loanSnapshot = await once(ref(realtimeDb, `loans/${loanId}`)); // Use ref and once with realtimeDb
                if (loanSnapshot.exists()) {
                    const loan = loanSnapshot.val();
                    const currentBalance = Number(loan.balance) || loan.totalAmount;

                    if (paymentAmount > currentBalance) {
                        showAlert(`Payment amount exceeds outstanding balance of ${currentBalance.toFixed(2)}.`, "warning");
                        return;
                    }

                    const newPaidAmount = (Number(loan.paidAmount) || 0) + paymentAmount;
                    const newBalance = currentBalance - paymentAmount;

                    // Update loan in Realtime Database
                    await set(ref(realtimeDb, `loans/${loanId}`), {
                        ...loan, // Keep existing loan data
                        paidAmount: newPaidAmount,
                        balance: newBalance
                    });

                    // Add payment record to Realtime Database
                    const newPaymentRef = push(paymentsRef); // Use push with paymentsRef
                    await set(newPaymentRef, {
                        paymentId: newPaymentRef.key,
                        loanId: loanId,
                        amount: paymentAmount,
                        date: new Date().toISOString(),
                        note: paymentNote
                    });

                    showAlert("Payment added successfully!", "success");
                    hideCustomModal(addPaymentModal);
                    // Reload loans for the current customer
                    await loadLoansForCustomer(customerPhoneInput.value, loansRef, paymentsRef, loanListDiv);
                } else {
                    showAlert("Loan not found.", "error");
                }
            } catch (error) {
                console.error("Error processing payment:", error);
                showAlert("Failed to process payment.", "error");
            } finally {
                hideLoader();
            }
        });

        // Failsafe to hide loader
        setTimeout(() => {
            const loader = document.getElementById("page-loader");
            if (loader && !loader.classList.contains('hidden')) {
                loader.classList.add('hidden');
                console.warn("Loader hidden by failsafe timeout. Check console for any preceding errors.");
            }
        }, 20000);
    </script>
</body>
</html>
