<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Manage Stock - WR Smile</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Google Fonts for Luxury Feel: Inter for body, Playfair Display for headings -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Base Body Styling for Luxury UI */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(145deg, #e0e7ee, #c8d3e0);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 20px;
            color: #334155;
            box-sizing: border-box;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
        }

        .container {
            width: 100%;
            max-width: 900px;
            margin-top: 20px;
        }

        .card {
            background-color: #ffffff;
            border-radius: 1.5rem;
            padding: 2.5rem;
            box-shadow: 10px 10px 20px rgba(0, 0, 0, 0.05), -10px -10px 20px rgba(255, 255, 255, 0.5);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.6);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 15px 15px 30px rgba(0, 0, 0, 0.07), -15px -15px 30px rgba(255, 255, 255, 0.7);
        }

        .input-style {
            padding: 0.75rem 1.5rem;
            border: none;
            background-color: #f0f4f8;
            border-radius: 9999px; /* full rounded */
            box-shadow: inset 2px 2px 5px #c8d3e0, inset -2px -2px 5px #ffffff;
            transition: all 0.3s ease;
        }
        .input-style:focus {
            outline: none;
            box-shadow: inset 3px 3px 8px #b9c7d8, inset -3px -3px 8px #ffffff;
        }

        .btn-style {
            padding: 0.75rem 2rem;
            border: none;
            font-weight: 600;
            border-radius: 9999px; /* full rounded */
            box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.1), -5px -5px 10px rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .btn-style:hover {
            transform: translateY(-2px);
            box-shadow: 8px 8px 15px rgba(0, 0, 0, 0.1), -8px -8px 15px rgba(255, 255, 255, 0.6);
        }

        .btn-style:active {
            transform: translateY(0);
            box-shadow: inset 3px 3px 6px rgba(0, 0, 0, 0.2), inset -3px -3px 6px rgba(255, 255, 255, 0.4);
        }
        
        /* Specific button colors */
        .btn-primary {
            background-color: #4f46e5;
            color: #ffffff;
        }
        .btn-secondary {
            background-color: #94a3b8;
            color: #ffffff;
        }
        .btn-danger {
            background-color: #ef4444;
            color: #ffffff;
        }
        .btn-edit {
            color: #2563eb;
        }
        .btn-delete {
            color: #dc2626;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #f0f4f8;
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 10px 10px 20px rgba(0, 0, 0, 0.1), -10px -10px 20px rgba(255, 255, 255, 0.6);
            width: 90%;
            max-width: 500px;
        }
        .modal-content input {
            width: 100%;
        }

        /* Message/Alerts */
        .message-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1001;
            display: flex;
            flex-direction: column-reverse;
            gap: 10px;
        }
        .message {
            padding: 1rem 1.5rem;
            border-radius: 1rem;
            box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.1), -5px -5px 10px rgba(255, 255, 255, 0.5);
            animation: fadeInOut 4s forwards;
            min-width: 250px;
            text-align: center;
        }
        .message.success {
            background-color: #d1fae5;
            color: #065f46;
        }
        .message.error {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(20px); }
        }

        /* Loader styles */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1002;
        }
        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #4f46e5;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Main Content Container -->
    <div class="container mx-auto p-4">
        <h1 class="text-4xl text-center mb-8">Stock Management</h1>
        <p id="userIdDisplay" class="text-xs text-center text-gray-400 mb-4"></p>

        <!-- Form for Adding New Products Directly -->
        <div class="card p-6 mb-8">
            <h2 class="text-2xl mb-4">Add New Product</h2>
            <form id="addProductForm" class="space-y-4">
                <input type="text" id="addProductName" placeholder="Product Name" required class="input-style">
                <input type="number" id="addProductPrice" placeholder="Price (Rs)" required class="input-style">
                <input type="number" id="addProductStock" placeholder="Stock" required class="input-style">
                <div class="flex justify-center mt-6">
                    <button type="submit" class="btn-style btn-primary">Add Product</button>
                </div>
            </form>
        </div>

        <!-- Stock List Card -->
        <div class="card p-6">
            <h2 class="text-2xl mb-4">Current Stock</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-left table-auto">
                    <thead>
                        <tr class="text-gray-600 uppercase text-sm leading-normal">
                            <th class="py-3 px-6">Product</th>
                            <th class="py-3 px-6">Price</th>
                            <th class="py-3 px-6">Stock</th>
                            <th class="py-3 px-6 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="stockTableBody" class="text-gray-600 text-sm font-light">
                        <!-- Product rows will be injected here -->
                    </tbody>
                </table>
            </div>
            <p id="noProductsMessage" class="text-center text-gray-500 mt-4 hidden">No products in stock. Add some above!</p>
        </div>
    </div>

    <!-- Modals -->
    <!-- Edit Product Modal -->
    <div id="editProductModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-2xl mb-4 text-center">Edit Product</h3>
            <form id="editProductForm" class="space-y-4">
                <input type="hidden" id="editProductId">
                <input type="text" id="editProductName" placeholder="Product Name" required class="input-style">
                <input type="number" id="editProductPrice" placeholder="Price (Rs)" required class="input-style">
                <input type="number" id="editProductStock" placeholder="Stock" required class="input-style">
                <div class="flex justify-center space-x-4 mt-6">
                    <button type="submit" class="btn-style btn-primary">Update</button>
                    <button type="button" id="cancelEditBtn" class="btn-style btn-secondary">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal for Deletion -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content text-center">
            <h3 class="text-2xl mb-4 text-center">Confirm Deletion</h3>
            <p class="text-gray-700 mb-6">Are you sure you want to delete this product?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirmDeleteBtn" class="btn-style btn-danger">Delete</button>
                <button id="cancelConfirmBtn" class="btn-style btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Message Container -->
    <div id="messageContainer" class="message-container"></div>

    <!-- Loader Overlay -->
    <div id="loaderOverlay" class="loader-overlay">
        <div class="loader"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyACehOi7n-dbdN00D4tJr2kD_-AVR6S-Vo",
            authDomain: "wr-smile-shop.firebaseapp.com",
            databaseURL: "https://wr-smile-shop-default-rtdb.firebaseio.com",
            projectId: "wr-smile-shop",
            storageBucket: "wr-smile-shop.firebasestorage.app",
            messagingSenderId: "299864260187",
            appId: "1:299864260187:web:fa6af65ef95674aff1097e",
            measurementId: "G-3Z38G6MCYJ"
        };
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let db;
        let auth;
        let userId = null;

        let productToDeleteId = null;

        // UI Element References
        const stockTableBody = document.getElementById('stockTableBody');
        const noProductsMessage = document.getElementById('noProductsMessage');
        const editProductModal = document.getElementById('editProductModal');
        const addProductForm = document.getElementById('addProductForm');
        const addProductNameInput = document.getElementById('addProductName');
        const addProductPriceInput = document.getElementById('addProductPrice');
        const addProductStockInput = document.getElementById('addProductStock');
        const editProductForm = document.getElementById('editProductForm');
        const editProductIdInput = document.getElementById('editProductId');
        const editProductNameInput = document.getElementById('editProductName');
        const editProductPriceInput = document.getElementById('editProductPrice');
        const editProductStockInput = document.getElementById('editProductStock');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const confirmModal = document.getElementById('confirmModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelConfirmBtn = document.getElementById('cancelConfirmBtn');
        const messageContainer = document.getElementById('messageContainer');
        const loaderOverlay = document.getElementById('loaderOverlay');
        const userIdDisplay = document.getElementById('userIdDisplay');

        // Functions for Modals
        const showCustomModal = (modal) => modal.style.display = 'flex';
        const hideCustomModal = (modal) => modal.style.display = 'none';

        // Functions for Messages and Loader
        const showMessage = (message, type) => {
            const messageDiv = document.createElement('div');
            messageDiv.textContent = message;
            messageDiv.className = `message ${type}`;
            messageContainer.appendChild(messageDiv);
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        };
        const showLoader = () => { loaderOverlay.style.display = 'flex'; };
        const hideLoader = () => { loaderOverlay.style.display = 'none'; };

        // Helper to disable/enable forms
        const setFormState = (disabled) => {
            const forms = [addProductForm, editProductForm];
            forms.forEach(form => {
                const inputs = form.querySelectorAll('input, button');
                inputs.forEach(input => {
                    input.disabled = disabled;
                    input.readOnly = disabled;
                });
            });
        };

        // Firebase Authentication and Initialization
        const authenticate = async () => {
            showLoader();
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Listen for authentication state changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `User ID: ${userId}`;
                        setFormState(false);
                        const productsCollectionPath = `artifacts/${appId}/users/${userId}/stock`;
                        setupRealtimeListener(productsCollectionPath);
                        showMessage("Authentication successful!", 'success');
                    } else {
                        userId = null;
                        userIdDisplay.textContent = `User ID: Not authenticated`;
                        setFormState(true);
                        stockTableBody.innerHTML = '';
                        noProductsMessage.classList.remove('hidden');
                        showMessage("Please wait, authenticating...", "error");
                    }
                    hideLoader();
                });

                // Directly sign in anonymously to ensure the app works for all users.
                await signInAnonymously(auth);

            } catch (error) {
                console.error("Authentication or Firebase initialization error:", error);
                showMessage("Authentication failed. Check the console for more details.", "error");
                setFormState(true);
                hideLoader();
            }
        };

        // Real-time listener for stock data
        const setupRealtimeListener = (collectionPath) => {
            if (!db) {
                console.error("Firestore instance (db) is not initialized.");
                return;
            }
            onSnapshot(collection(db, collectionPath), (snapshot) => {
                stockTableBody.innerHTML = '';
                if (snapshot.empty) {
                    noProductsMessage.classList.remove('hidden');
                } else {
                    noProductsMessage.classList.add('hidden');
                    snapshot.forEach(doc => {
                        renderProductRow({ id: doc.id, ...doc.data() });
                    });
                }
            }, (error) => {
                console.error("Error fetching documents:", error);
                showMessage("Failed to load stock data.", "error");
            });
        };

        // Render a single product row in the table
        const renderProductRow = (product) => {
            const row = document.createElement('tr');
            row.className = "hover:bg-gray-100 transition-colors duration-150 border-b border-gray-200 last:border-0";
            row.innerHTML = `
                <td class="py-4 px-6">${product.name}</td>
                <td class="py-4 px-6">Rs ${product.price.toFixed(2)}</td>
                <td class="py-4 px-6">${product.stock}</td>
                <td class="py-4 px-6 text-right space-x-2">
                    <button class="btn-edit text-sm" data-id="${product.id}"><i class="fas fa-edit"></i></button>
                    <button class="btn-delete text-sm" data-id="${product.id}"><i class="fas fa-trash"></i></button>
                </td>
            `;
            stockTableBody.appendChild(row);
        };

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            authenticate();

            // Handle Add Product Form Submission
            addProductForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!db || !userId) {
                    showMessage("Database not ready. Please wait.", "error");
                    return;
                }
                showLoader();

                const name = addProductNameInput.value.trim();
                const price = parseFloat(addProductPriceInput.value);
                const stock = parseInt(addProductStockInput.value);

                if (name && !isNaN(price) && !isNaN(stock) && stock >= 0) {
                    const productData = { name, price, stock };
                    const productsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/stock`);

                    try {
                        await addDoc(productsCollectionRef, productData);
                        showMessage("Product saved successfully!", "success");
                        addProductForm.reset();
                    } catch (error) {
                        console.error("Error saving product:", error);
                        showMessage('Failed to save product: ' + error.message, "error");
                    } finally {
                        hideLoader();
                    }
                } else {
                    showMessage("Please fill all fields with valid data.", "error");
                    hideLoader();
                }
            });

            // Handle Edit Product Form Submission
            editProductForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!db || !userId) {
                    showMessage("Database not ready. Please wait.", "error");
                    return;
                }
                showLoader();

                const id = editProductIdInput.value;
                const name = editProductNameInput.value.trim();
                const price = parseFloat(editProductPriceInput.value);
                const stock = parseInt(editProductStockInput.value);

                if (name && !isNaN(price) && !isNaN(stock) && stock >= 0) {
                    const productData = { name, price, stock };
                    const productsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/stock`);

                    try {
                        const productRef = doc(productsCollectionRef, id);
                        await updateDoc(productRef, productData);
                        showMessage("Product updated successfully!", "success");
                        hideCustomModal(editProductModal);
                    } catch (error) {
                        console.error("Error updating product:", error);
                        showMessage('Failed to update product: ' + error.message, "error");
                    } finally {
                        hideLoader();
                    }
                } else {
                    showMessage("Please fill all fields with valid data.", "error");
                    hideLoader();
                }
            });


            // Handle Clicks on Edit/Delete Buttons using event delegation
            stockTableBody.addEventListener('click', async (e) => {
                const targetBtn = e.target.closest('button');
                if (!targetBtn || !db || !userId) return;

                const productId = targetBtn.dataset.id;
                
                if (targetBtn.classList.contains('btn-delete')) {
                    // Handle Delete
                    productToDeleteId = productId;
                    showCustomModal(confirmModal);
                } else if (targetBtn.classList.contains('btn-edit')) {
                    // Handle Edit
                    showLoader();
                    try {
                        const productsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/stock`);
                        const docRef = doc(productsCollectionRef, productId);
                        const docSnap = await getDoc(docRef);

                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            editProductIdInput.value = productId;
                            editProductNameInput.value = data.name;
                            editProductPriceInput.value = data.price;
                            editProductStockInput.value = data.stock;
                            showCustomModal(editProductModal);
                        } else {
                            showMessage("Product not found.", "error");
                        }
                    } catch (error) {
                        console.error("Error fetching product for edit:", error);
                        showMessage('Failed to load product details for editing: ' + error.message, "error");
                    } finally {
                        hideLoader();
                    }
                }
            });

            // Cancel button for Edit Modal
            cancelEditBtn.addEventListener('click', () => {
                hideCustomModal(editProductModal);
                editProductForm.reset();
            });

            // Confirmation Modal Buttons
            cancelConfirmBtn.addEventListener('click', () => {
                hideCustomModal(confirmModal);
                productToDeleteId = null;
            });
            confirmDeleteBtn.addEventListener('click', async () => {
                if (!productToDeleteId || !db || !userId) return;
                showLoader();
                try {
                    const productsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/stock`);
                    await deleteDoc(doc(productsCollectionRef, productToDeleteId));
                    showMessage("Product deleted successfully!", "success");
                } catch (error) {
                    console.error("Error deleting product:", error);
                    showMessage('Failed to delete product: ' + error.message, "error");
                } finally {
                    hideCustomModal(confirmModal);
                    hideLoader();
                    productToDeleteId = null;
                }
            });
        });
    </script>
</body>
</html>
